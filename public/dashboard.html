<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🧸 Fruitful Smart Toys™ 🌈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>
    <style>
        /* Define Fruitful Global Color Palette and Base Styles */
        :root {
            /* Dark Mode Defaults */
            --primary-color: #0071e3; /* Apple Blue */
            --secondary-color: #facc15; /* Yellow-400 for Smart Toys accent */
            --text-color-light: #f5f5f7; /* Light text on dark backgrounds */
            --text-color-dark: #1d1d1f; /* Dark text on light backgrounds - used for some components that flip colors */
            --bg-color-dark: #1a1a1c; /* Deep black/dark grey */
            --card-bg-dark: #2a2a2e; /* Darker grey for dark cards */
            --border-color-dark: #3a3a3e; /* Subtle dark border */
            --accent-gold: #B8860B; /* Corporate gold accent (retained for general use) */
            --status-active: #30d158; /* Green for active */
            --status-pending: #f59e0b; /* Amber for pending */
            --status-draft: #6e6e73; /* Gray for draft */
            --status-error: #ef4444; /* Red for error */

            /* Light Mode Variables (will override dark mode) - Inspired by Smart Toys HTML */
            --light-primary-color: #0071e3; /* Apple Blue */
            --light-secondary-color: #facc15; /* Yellow-400 */
            --light-text-color-light: #1d1d1f; /* Dark text for light mode body */
            --light-text-color-dark: #1d1d1f; /* Dark text for light mode body content */
            --light-bg-color-dark: #f5f5f7; /* Very light gray, almost white */
            --light-card-bg-dark: #ffffff; /* White for light cards */
            --light-border-color-dark: #e8e8ed; /* Subtle light border */
        }

        /* Base Body Styling - Defaults to dark mode based on root variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-dark);
            color: var(--text-color-light); /* Main text color based on mode */
            min-height: 100vh;
            display: flex;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            margin: 0;
            padding: 0;
        }

        /* Light Mode specific overrides */
        body.light-mode {
            background-color: var(--light-bg-color-dark);
            color: var(--light-text-color-light);

            /* Overrides for specific components in light mode */
            .sidebar, .panel, .metric-card, .project-card, .chart-container, .custom-modal-content, .company-select-card {
                background-color: var(--light-card-bg-dark);
                border-color: var(--light-border-color-dark);
                box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Lighter shadow */
            }
            .sidebar-header .logo-text {
                color: var(--light-text-color-light); /* Fruitful part darker */
            }
            .sidebar-header .logo-text span { /* ToyNest part in Yellow-400 */
                color: var(--light-secondary-color);
            }
            .nav-list a {
                color: var(--light-text-color-dark); /* Darker nav text */
            }
            .nav-list a:hover {
                background-color: rgba(0, 113, 227, 0.05); /* Lighter hover background */
                color: var(--light-primary-color);
            }
            .nav-list a.active {
                background-color: var(--light-primary-color);
                color: white;
            }
            .nav-icon {
                color: var(--light-secondary-color); /* Yellow remains contrast */
            }
            .panel h3, .panel h4 {
                color: var(--light-secondary-color); /* Yellow for headings */
            }
            .panel p, .project-card p, .api-key-value, .form-control label, .form-control input, .form-control select, .form-control textarea {
                color: var(--light-text-color-dark); /* Darker text for readability */
            }
            .form-control input[type="text"],
            .form-control input[type="email"],
            .form-control input[type="password"],
            .form-control select,
            .form-control textarea {
                background-color: #ebebeb; /* Lighter input fields */
                border-color: #d1d1d1;
                color: var(--light-text-color-light); /* Input text darker */
            }
            .project-card {
                background-color: #f0f0f0; /* Lighter project cards in light mode */
                border-color: #d1d1d1;
            }
            .project-actions button {
                color: black; /* Button text black for yellow bg */
                background-color: var(--light-secondary-color); /* Yellow buttons */
            }
            .project-actions button:hover {
                background-color: #d9b813; /* Darker yellow on hover */
                color: black;
            }
            .project-actions button.secondary {
                color: var(--light-primary-color);
                border-color: var(--light-primary-color);
                background-color: transparent;
            }
            .project-actions button.secondary:hover {
                background-color: rgba(0, 113, 227, 0.08);
            }
            .api-key-table th {
                background-color: #e8e8ed;
            }
            .api-key-table tr:hover {
                background-color: #f0f0f0;
            }
            .security-note {
                background-color: rgba(239, 68, 68, 0.08);
                color: #dc2626;
            }
            .template-preview-frame {
                background-color: #f8f8f8; /* Lighter iframe background */
            }
            .editor-container {
                background-color: var(--light-bg-color-dark);
            }
            .editor-header {
                background-color: var(--light-card-bg-dark);
                border-bottom: 1px solid var(--light-border-color-dark);
            }
            .code-editor, .preview-area {
                background-color: var(--light-card-bg-dark);
                border-color: var(--light-border-color-dark);
            }
            .code-editor textarea,
            #editorSectionTopicInput,
            #editorRephraseTextInput,
            #editorGeneratedContentOutput,
            .editor-content-area input {
                background-color: #ebebeb;
                border-color: #d1d1d1;
                color: var(--light-text-color-dark);
            }
            .editor-actions button {
                color: var(--light-text-color-dark); /* Dark button text */
            }
            .editor-actions button.secondary {
                color: var(--light-primary-color);
                border-color: var(--light-primary-color);
            }
            .editor-actions button.secondary:hover {
                background-color: rgba(0, 113, 227, 0.08);
            }
            .copy-square pre {
                 color: var(--light-text-color-dark);
            }
            .toggle-section-btn span {
                color: var(--light-text-color-dark) !important;
            }
        }


        /* Sidebar Styling */
        .sidebar {
            width: 280px; /* Wider sidebar */
            background-color: var(--card-bg-dark);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--border-color-dark);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto; /* Scrollable sidebar */
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative; /* For theme toggle button positioning */
        }
        .sidebar-header .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color-light); /* Icon color changes with theme */
            transition: color 0.3s ease;
        }
        .sidebar-header .theme-toggle:hover {
            color: var(--primary-color);
        }
        .sidebar-header .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: #FFFFFF; /* Fruitful part in white */
            line-height: 1; /* Adjust line height for better alignment */
        }
        .sidebar-header .logo-text span {
            color: var(--secondary-color); /* ToyNest part in Yellow */
            font-size: 0.8em; /* Make 'ToyNest' slightly smaller relative to 'Fruitful' */
            letter-spacing: -0.02em; /* Tighter spacing for "ToyNest" */
        }
        .nav-list a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            color: var(--text-color-light); /* Nav text color changes with theme */
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
        }
        .nav-list a:hover {
            background-color: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
        }
        .nav-list a.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
        }
        .nav-list a.active .nav-icon {
            color: white;
        }
        .nav-icon {
            font-size: 1.2rem;
            color: var(--secondary-color);
            transition: color 0.2s ease;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 2.5rem;
            background-color: var(--bg-color-dark); /* Background changes with theme */
            overflow-y: auto; /* Scrollable main content */
        }

        /* General Panel Styling */
        .panel {
            background-color: var(--card-bg-dark); /* Panel background changes with theme */
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .panel h3, .panel h4 {
            color: var(--secondary-color);
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        .panel h3 { font-size: 1.8rem; }
        .panel h4 { font-size: 1.4rem; }
        .panel p {
            color: var(--text-color-light); /* Paragraph text changes with theme */
            line-height: 1.6;
        }

        /* Metric Cards */
        .metric-card {
            background-color: var(--card-bg-dark); /* Metric card background changes with theme */
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        /* Light mode specific override for metric card background */
        body.light-mode .metric-card {
            background-color: var(--light-card-bg-dark);
            border-color: var(--light-border-color-dark);
        }
        .metric-card h4 {
            font-size: 1rem;
            color: var(--text-color-light); /* Metric title changes with theme */
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .metric-card p {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0;
            line-height: 1.1;
        }

        /* Project Grid */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .project-card {
            background-color: #1a1a1a; /* Project card background (slightly lighter dark) */
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid #3a3a3e; /* Border based on this card's color */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        /* Light mode specific override for project card background */
        body.light-mode .project-card {
            background-color: #f0f0f0; /* Lighter project cards in light mode */
            border-color: #d1d1d1;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .project-card h4 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .project-card p {
            font-size: 0.9rem;
            color: var(--text-color-light); /* Project card text color changes with theme */
            margin-bottom: 0.4rem;
        }
        /* Light mode specific override for project card text */
        body.light-mode .project-card p {
            color: var(--text-color-dark);
        }
        .project-status {
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            font-size: 0.8rem;
        }
        .status-live { background-color: var(--status-active); color: white; }
        .status-pending { background-color: var(--status-pending); color: black; } /* pending in yellow/black */
        .status-draft { background-color: var(--status-draft); color: white; }
        .status-error { background-color: var(--status-error); color: white; }
        .project-actions button {
            background-color: var(--secondary-color);
            color: black; /* Text black for yellow buttons */
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 0.8rem;
            margin-right: 0.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .project-actions button:hover {
            background-color: #d9b813; /* Darker yellow for hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(250,204,21,0.3);
            color: black;
        }
        .project-actions button.secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .project-actions button.secondary:hover {
            background-color: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        /* Form styling */
        .form-control {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .form-control label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color-light); /* Label text changes with theme */
        }
        body.light-mode .form-control label {
            color: var(--text-color-dark); /* Darker labels in light mode */
        }
        .form-control input[type="text"],
        .form-control input[type="email"],
        .form-control input[type="password"],
        .form-control select,
        .form-control textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: #3a3a3e; /* Input background changes with theme */
            color: var(--text-color-light); /* Input text color changes with theme */
            font-size: 1rem;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        body.light-mode .form-control input, body.light-mode .form-control select, body.light-mode .form-control textarea {
            background-color: #ebebeb; /* Lighter input fields */
            border-color: #d1d1d1;
            color: var(--text-color-dark);
        }
        .form-control input:focus, .form-control select:focus, .form-control textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.3);
        }
        .form-action-button {
            background-color: var(--secondary-color);
            color: black; /* Text black for yellow buttons */
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .form-action-button:hover {
            background-color: #d9b813; /* Darker yellow hover */
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(250,204,21,0.3);
            color: black;
        }
        .form-action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Analytics Chart specific styling */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            background-color: var(--bg-color-dark); /* Dark background for charts */
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        /* Light mode specific override for chart background */
        body.light-mode .chart-container {
            background-color: #f0f0f0;
            border-color: #d1d1d1;
        }

        /* API Keys table styling */
        .api-key-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            text-align: left;
        }
        .api-key-table th, .api-key-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border-color-dark); /* Border changes with theme */
        }
        body.light-mode .api-key-table th, body.light-mode .api-key-table td {
            border-color: var(--light-border-color-dark);
        }
        .api-key-table th {
            background-color: #1a1a1a; /* Header background (slightly lighter dark) */
            color: var(--secondary-color);
            font-weight: 600;
        }
        body.light-mode .api-key-table th {
            background-color: #e8e8ed;
        }
        .api-key-table tr:hover {
            background-color: #3a3a3e; /* Row hover background */
        }
        body.light-mode .api-key-table tr:hover {
            background-color: #f0f0f0;
        }
        .api-key-value {
            font-family: 'monospace';
            font-size: 0.85rem;
            color: var(--text-color-light); /* Key value text changes with theme */
            word-break: break-all;
        }
        body.light-mode .api-key-value {
            color: var(--text-color-dark);
        }
        .security-note {
            background-color: #ef444420; /* Light red background */
            border-left: 4px solid var(--status-error);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            color: #ef4444; /* Red text */
            font-size: 0.9rem;
            text-align: left;
        }


        /* Utility for hidden views */
        .view-hidden {
            display: none;
        }

        /* Custom Modal for Alerts */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0; /* Start hidden for fade effect */
            visibility: hidden; /* Prevent interaction when hidden */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: var(--card-bg-dark); /* Modal background changes with theme */
            color: var(--text-color-light); /* Modal text changes with theme */
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            transform: translateY(-20px); /* Start slightly up for animation */
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        body.light-mode .custom-modal-content {
            background-color: var(--light-card-bg-dark);
            color: var(--text-color-dark);
            border-color: var(--light-border-color-dark);
        }
        .custom-modal-overlay.active .custom-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .custom-modal-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }


        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Template Preview Modal */
        #templatePreviewModal .template-preview-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #templatePreviewModal .template-preview-header h3 {
            color: white;
            margin: 0;
        }
        #templatePreviewModal .close-preview-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #templatePreviewModal .close-preview-btn:hover {
            transform: scale(1.1);
        }
        #templatePreviewModal .template-preview-body {
            padding: 1.5rem;
            background-color: var(--card-bg-dark);
        }
        #templatePreviewModal .template-preview-frame {
            width: 100%;
            height: 400px; /* Fixed height for preview */
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            background-color: #1a1a1c; /* Dark background for iframe */
        }
        #templatePreviewModal .template-preview-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .btn-primary {
            background-color: var(--secondary-color);
            color: black; /* Text black for yellow buttons */
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #d9b813; /* Darker yellow */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--status-draft);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #525257;
            transform: translateY(-1px);
        }

        /* Ecosystem Map Styling */
        .copy-square {
            position: relative;
            background-color: #3a3a3e;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            border: 1px solid var(--border-color-dark);
        }
        body.light-mode .copy-square {
            background-color: #e8e8ed;
            border-color: #d1d1d1;
        }
        .copy-square .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--primary-color);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease;
        }
        .copy-square:hover .copy-button {
            opacity: 1; /* Show on hover */
        }
        .copy-square .copy-button:hover {
            background-color: #005bb5;
        }
        .copy-square pre.conversation-code-block {
            background: none;
            border: none;
            color: var(--text-color-light); /* Ensure text is visible in dark mode */
            padding: 0;
            margin: 0;
            font-size: 0.85rem;
            white-space: pre-wrap; /* Preserve formatting but wrap long lines */
            word-break: break-all; /* Break long words if necessary */
            padding-right: 40px; /* Make space for the copy button */
        }
        body.light-mode .copy-square pre.conversation-code-block {
            color: var(--text-color-dark);
        }

        .toggle-section-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color); /* Matches current active nav link or primary color */
            transition: color 0.2s ease;
        }
        body.light-mode .toggle-section-btn {
            color: var(--light-primary-color);
        }
        .toggle-section-btn:hover {
            color: var(--primary-color);
        }
        .toggle-section-btn i {
            margin-left: 0.5rem;
            transition: transform 0.2s ease;
        }
        .toggle-section-btn i.fa-chevron-up {
            transform: rotate(180deg);
        }
        .repo-content-section {
            padding-left: 1rem;
            border-left: 2px solid var(--border-color-dark); /* Indent and show hierarchy */
            margin-top: 1rem;
            padding-top: 0.5rem;
        }
        body.light-mode .repo-content-section {
            border-color: var(--light-border-color-dark);
        }
        .repo-content-section .toggle-section-btn {
            font-size: 1rem; /* Smaller for nested levels */
            font-weight: 500;
            color: var(--text-color-light); /* Nested sections use lighter text color */
        }
        body.light-mode .repo-content-section .toggle-section-btn {
            color: var(--text-color-dark);
        }

        /* Ecosystem Map specific section-intro and section-title */
        #ecosystem-map-view .section-title {
            color: var(--secondary-color);
            font-size: 2.2rem;
            font-weight: 800;
        }
        #ecosystem-map-view .section-intro {
            color: var(--text-color-light);
            text-align: center;
            font-size: 1.1rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        body.light-mode #ecosystem-map-view .section-intro {
            color: var(--text-color-dark);
        }

        /* Global Checkout Styling */
        #ecosystem-map-view #checkout-step-1,
        #ecosystem-map-view #checkout-step-2,
        #ecosystem-map-view #checkout-step-3 {
            background-color: var(--card-bg-dark);
            border: 1px solid var(--border-color-dark);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        #ecosystem-map-view .step-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            margin-right: 0.75rem;
        }
        #ecosystem-map-view .checkout-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: #3a3a3e;
            color: var(--text-color-light);
            font-size: 1rem;
        }
        #ecosystem-map-view .checkout-button {
            background-color: var(--secondary-color);
            color: black; /* Text black for yellow buttons */
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        #ecosystem-map-view .checkout-button:hover {
            background-color: #d9b813; /* Darker yellow */
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(250,204,21,0.3);
            color: black;
        }

        /* Editor Workspace Styling */
        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 5rem); /* Adjust based on main-content padding */
            background-color: var(--card-bg-dark);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color-dark);
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #1a1a1a; /* Slightly lighter dark for header */
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color-dark);
        }
        .editor-content-area {
            display: flex;
            flex-grow: 1;
            overflow: hidden; /* Prevent content overflow */
        }
        .code-editor, .preview-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .code-editor {
            border-right: 1px solid var(--border-color-dark);
        }
        .code-editor textarea {
            background-color: #3a3a3e;
            border: 1px solid var(--border-color-dark);
            color: var(--text-color-light);
            padding: 0.75rem;
            border-radius: 8px;
            font-family: 'monospace';
            font-size: 0.9rem;
            flex-grow: 1; /* Allow textarea to take available height */
            min-height: 150px; /* Minimum height for code areas */
            resize: vertical; /* Allow vertical resizing */
        }
        .preview-area iframe {
            width: 100%;
            flex-grow: 1; /* Allow iframe to take available height */
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            background-color: #f8f8f8; /* Light background for iframe content */
            min-height: 300px;
        }
        .editor-actions {
            padding: 1rem 1.5rem;
            background-color: #1a1a1a;
            border-top: 1px solid var(--border-color-dark);
            gap: 1rem;
        }
        .editor-actions button {
            margin-top: 0; /* Override default margin-top from .form-action-button */
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
        }

        /* Settings Tab Navigation */
        .settings-tab-btn {
            padding: 0.75rem 1.25rem;
            background-color: transparent;
            border: none;
            color: var(--text-color-light);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        body.light-mode .settings-tab-btn {
            color: var(--text-color-dark);
        }
        .settings-tab-btn:hover {
            color: var(--primary-color);
            border-color: rgba(0, 113, 227, 0.5);
        }
        .settings-tab-btn.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Company Selection Card for Settings */
        .company-select-card {
            background-color: #2a2a2e; /* Darker grey background */
            border: 1px solid var(--border-color-dark); /* Dark border */
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        body.light-mode .company-select-card {
            background-color: var(--light-card-bg-dark);
            border-color: var(--light-border-color-dark);
        }
        .company-select-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .company-details-section {
            background-color: #2a2a2e;
            border: 1px solid var(--border-color-dark);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-top: 2.5rem;
        }
        body.light-mode .company-details-section {
            background-color: var(--light-card-bg-dark);
            border-color: var(--light-border-color-dark);
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .editor-content-area {
                flex-direction: row;
            }
            .code-editor, .preview-area {
                border-right: 1px solid var(--border-color-dark); /* Separator in desktop view */
            }
            .preview-area {
                border-right: none; /* No right border on last item */
            }
        }
        @media (max-width: 767px) {
            .editor-content-area {
                flex-direction: column;
            }
            .code-editor, .preview-area {
                border-bottom: 1px solid var(--border-color-dark);
            }
            .preview-area {
                border-bottom: none;
            }
            .editor-actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }


        /* Responsive Mobile Layout */
        @media (max-width: 767px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                padding: 1rem;
                border-right: none;
                border-bottom: 1px solid var(--border-color-dark);
                flex-direction: row; /* Horizontal layout for mobile nav */
                justify-content: space-around;
                flex-wrap: wrap; /* Allow nav items to wrap */
                position: sticky; /* Keep sidebar visible on scroll */
                top: 0;
                z-index: 40; /* Ensure it's above main content when scrolling */
            }
            .sidebar-header {
                width: 100%;
                margin-bottom: 1rem;
                display: flex; /* Make it a flex container to center logo */
                justify-content: center; /* Center logo horizontally */
                align-items: center;
                height: auto; /* Allow height to adjust */
            }
            .sidebar-header .theme-toggle {
                position: relative; /* Adjust position for mobile, remove absolute positioning */
                top: auto;
                right: auto;
                margin-left: 1rem; /* Add some spacing */
            }
            .sidebar-header .logo-text {
                font-size: 1.5rem; /* Adjust font size for mobile */
                letter-spacing: -0.01em;
            }
            .sidebar-header .logo-text span {
                font-size: 0.8em; /* Keep relative size */
            }
            .nav-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
            .nav-list a {
                margin: 0.2rem 0.3rem; /* Tighter spacing for mobile nav items */
                padding: 0.5rem 0.6rem;
                font-size: 0.75rem; /* Smaller font size */
                gap: 0.5rem; /* Smaller gap for icon/text */
                flex-grow: 1; /* Allow items to stretch to fill space */
                justify-content: center; /* Center text within small buttons */
            }
            .nav-list a .nav-icon {
                font-size: 0.9rem; /* Smaller icon on mobile */
                margin-right: 0.2rem;
            }

            .main-content {
                padding: 1rem; /* Reduced padding for main content */
            }
            .panel {
                padding: 1.5rem; /* Reduced panel padding */
                margin-bottom: 1.5rem;
            }
            .panel h3 { font-size: 1.5rem; margin-bottom: 1rem;}
            .panel h4 { font-size: 1.2rem; margin-bottom: 0.8rem;}
            .metric-card p { font-size: 2rem; }
            .project-grid {
                grid-template-columns: 1fr; /* Stack projects on mobile */
                gap: 1rem;
            }
            .project-actions button {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                margin-right: 0.3rem;
                margin-top: 0.5rem;
            }
            .form-control {
                margin-bottom: 1rem;
            }
            .form-control input, .form-control select, .form-control textarea {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            .form-action-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
            .chart-container {
                height: 250px; /* Shorter charts on mobile */
            }
            .api-key-table th, .api-key-table td {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            .api-key-value {
                font-size: 0.7rem;
            }
            .security-note {
                padding: 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2 class="logo-text">Fruitful™ | <span>ToyNest™</span></h2>
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                <i class="fas fa-sun"></i> </button>
        </div>
        <nav class="nav-list">
            <a href="#dashboard" class="active" data-view="dashboard">
                <i class="fas fa-home nav-icon"></i> Dashboard
            </a>
            <a href="#projects" data-view="projects">
                <i class="fas fa-project-diagram nav-icon"></i> Projects
            </a>
            <a href="#new-project" data-view="new-project">
                <i class="fas fa-plus-circle nav-icon"></i> New Project
            </a>
            <a href="#scroll-builder" data-view="scroll-builder">
                <i class="fas fa-tools nav-icon"></i> Content Builder
            </a>
            <a href="#ecosystem-map" data-view="ecosystem-map">
                <i class="fas fa-sitemap nav-icon"></i> Ecosystem Map
            </a>
            <a href="#user-dashboards" data-view="user-dashboards">
                <i class="fas fa-users-cog nav-icon"></i> User Dashboards
            </a>
            <a href="#global-checkout" data-view="global-checkout">
                <i class="fas fa-shopping-cart nav-icon"></i> Global Payment
            </a>
            <a href="#templates" data-view="templates">
                <i class="fas fa-palette nav-icon"></i> Templates
            </a>
            <a href="#licenses" data-view="licenses">
                <i class="fas fa-file-contract nav-icon"></i> My Licenses
            </a>
            <a href="#analytics" data-view="analytics">
                <i class="fas fa-chart-line nav-icon"></i> Analytics
            </a>
            <a href="#api-keys" data-view="api-keys">
                <i class="fas fa-key nav-icon"></i> API Keys
            </a>
            <a href="#settings" data-view="settings">
                <i class="fas fa-cog nav-icon"></i> Settings
            </a>
            <a href="#login" data-view="login">
                <i class="fas fa-sign-in-alt nav-icon"></i> Sign In
            </a>
            <a href="#signup" data-view="signup">
                <i class="fas fa-user-plus nav-icon"></i> Sign Up
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <section id="dashboard-view" class="view">
            <div class="panel">
                <h3>Welcome Back, Smart Toys Innovator!</h3>
                <p class="mb-4">Your ToyNest™ portal provides comprehensive tools for developing, deploying, and managing educational smart toys and learning experiences across the Fruitful Global Treaty Grid.</p>
                <button class="form-action-button" onclick="showView('new-project')">
                    <i class="fas fa-plus-circle mr-2"></i> Start New Smart Toy Project
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="metric-card">
                    <h4>Active Smart Toy Engagements</h4>
                    <p id="totalProjectsCount">0</p>
                </div>
                <div class="metric-card">
                    <h4>Learning Modules Engaged</h4>
                    <p id="liveScrollsCount">0</p>
                </div>
                <div class="metric-card">
                    <h4>VaultMint™ Certifications</h4>
                    <p id="monthlyRoyalties">0</p>
                </div>
            </div>

            <div class="panel">
                <h3>Educational Systems Health Overview</h3>
                <div class="chart-container">
                    <canvas id="systemHealthChart"></canvas>
                </div>
            </div>
            
            <div class="panel">
                <h3>Fruitful Smart Toys™ Snapshot</h3>
                <p>Treaty-Class Cognitive Engines · OmniScroll Systems · VaultMint™ Certified.</p>
                <h4>Key Features:</h4>
                <ul>
                    <li>Smart Learning Companions: AI that grows with child's intelligence map</li>
                    <li>Speech Recognition Engine: Real-time language processing and feedback</li>
                    <li>Emotional Intelligence & Storytelling: Building empathy, creativity, emotional literacy</li>
                    <li>AI Parental Dashboard: Real-time emotional, academic progress reports</li>
                    <li>OmniScroll + Infinite Ledger Ready: Immutable proof of cognitive growth for life</li>
                </ul>
                <a href="https://faa.zone/sectors/education/smart-toys/index.html" target="_blank" class="form-action-button">Go to Fruitful Smart Toys™ Public Page →</a>
            </div>
        </section>

        <section id="projects-view" class="view view-hidden">
            <div class="panel">
                <h3>Your Smart Toy & Learning Projects</h3>
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <input type="text" id="projectSearch" placeholder="Search projects..." class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white">
                    <select id="projectFilterStatus" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-white">
                        <option value="all">All Statuses</option>
                        <option value="live">Deployed</option>
                        <option value="pending">Testing</option>
                        <option value="draft">Development</option>
                        <option value="error">Maintenance</option>
                    </select>
                </div>
                <div id="projectsList" class="project-grid">
                    </div>
                <div class="text-center mt-6">
                    <button id="loadMoreProjects" class="form-action-button"><i class="fas fa-sync-alt mr-2"></i> Load More Projects</button>
                </div>
            </div>
        </section>

        <section id="new-project-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-plus-circle mr-2"></i> Initiate a New Smart Toy Project</h3>
                <form id="newProjectForm">
                    <div class="form-control">
                        <label for="projectName">Project Name</label>
                        <input type="text" id="projectName" name="projectName" placeholder="e.g. AI Language Companion V2" required>
                    </div>

                    <div class="form-control">
                        <label for="template">Choose Template</label>
                        <select id="template" name="template" required>
                            <option value="">Loading templates...</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="description">Project Description</label>
                        <div class="flex items-center space-x-2">
                            <textarea id="description" name="description" rows="5" class="flex-grow" placeholder="Describe the educational focus, target age group, and core functionalities..."></textarea>
                            <button type="button" id="generateDescriptionBtn" class="form-action-button text-xs px-3 py-2">
                                <i class="fas fa-magic"></i> ✨ AI Generate Description
                            </button>
                        </div>
                        <p id="descriptionStatus" class="text-xs text-gray-400 mt-1"></p>
                    </div>

                    <div class="form-control">
                        <label for="projectConcept">High-Level Project Concept</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="projectConcept" placeholder="e.g., Personalized math tutor robot">
                            <button type="button" id="generateProjectIdeaBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ AI Project Idea
                            </button>
                        </div>
                        <p id="projectIdeaStatus" class="text-xs text-gray-400 mt-1"></p>
                    </div>

                    <div class="form-control">
                        <label for="region">Deployment Region</label>
                        <select id="region" name="region">
                            <option value="global">Global Rollout</option>
                            <option value="local">Regional Pilot</option>
                            <option value="beta">Beta Testing Group</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="claim">Enable ClaimRoot™ Auto-Certification?</label>
                        <select id="claim" name="claim">
                            <option value="yes">Yes – Certify this product</option>
                            <option value="no">No – Just save it</option>
                        </select>
                    </div>

                    <button type="submit" class="form-action-button">Create Project</button>
                    <p class="text-gray-500 text-sm mt-4">Projects will be saved in your ToyNest workspace and can be certified by VaultMint™ upon deployment.</p>
                </form>
            </div>
        </section>

        <section id="scroll-builder-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-tools mr-2"></i> Content Builder — Develop Toy Modules</h3>
                <form id="scrollBuilderForm">
                    <div class="form-control">
                        <label for="sbScrollName">Module Title</label>
                        <input type="text" id="sbScrollName" name="scrollName" placeholder="e.g. Interactive Phonics Lesson">
                    </div>

                    <div class="form-control">
                        <label for="sbScrollType">Module Type</label>
                        <select id="sbScrollType" name="scrollType">
                            <option value="">Loading types...</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="htmlCode">Learning Content / Toy Script Code</label>
                        <textarea id="htmlCode" name="htmlCode" rows="8" class="flex-grow" placeholder="Paste or write the toy's interactive script, AI dialogue, or learning module content..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineHtmlBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Refine Code
                            </button>
                            <button type="button" id="explainHtmlBtn" class="form-action-button secondary text-xs px-3 py-2">
                                ✨ Explain Code
                            </button>
                            <button type="button" id="reviewHtmlBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                ✨ Review Code
                            </button>
                            <label for="uploadHtml" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload Code
                                <input type="file" id="uploadHtml" accept=".html,.js,.json,.txt" class="hidden">
                            </label>
                            <input type="text" id="importHtmlUrl" placeholder="Import code from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importHtmlUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="htmlRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="htmlExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="htmlReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="cssCode">Styling/Visuals (for holographic units/AR)</label>
                        <textarea id="cssCode" name="cssCode" rows="6" class="flex-grow" placeholder="Add styling for interactive visuals, holographic projections, or AR overlays..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineCssBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Refine CSS
                            </button>
                            <button type="button" id="explainCssBtn" class="form-action-button secondary text-xs px-3 py-2">
                                ✨ Explain CSS
                            </button>
                            <button type="button" id="reviewCssBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                ✨ Review CSS
                            </button>
                            <label for="uploadCss" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload CSS
                                <input type="file" id="uploadCss" accept=".css" class="hidden">
                            </label>
                            <input type="text" id="importCssUrl" placeholder="Import CSS from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importCssUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="cssRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="cssExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="cssReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="jsCode">Logic/AI Scripts (Optional)</label>
                        <textarea id="jsCode" name="jsCode" rows="5" class="flex-grow" placeholder="Optional scripts for AI behavior, adaptive learning algorithms, sensor integration..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineJsBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Refine JavaScript
                            </button>
                            <button type="button" id="explainJsBtn" class="form-action-button secondary text-xs px-3 py-2">
                                ✨ Explain JavaScript
                            </button>
                            <button type="button" id="reviewJsBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                ✨ Review JavaScript
                            </button>
                            <label for="uploadJs" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload JS
                                <input type="file" id="uploadJs" accept=".js" class="hidden">
                            </label>
                            <input type="text" id="importJsUrl" placeholder="Import JS from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importJsUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="jsRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="jsExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="jsReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="scrollTopic">Module Topic (for AI Content Ideas)</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="scrollTopic" placeholder="e.g., Early literacy development, Social-emotional skills">
                            <button type="button" id="generateContentIdeasBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Generate Ideas
                            </button>
                        </div>
                        <p id="contentIdeasStatus" class="text-xs text-gray-400 mt-1"></p>
                        <textarea id="contentIdeasOutput" rows="8" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2" placeholder="Generated content ideas will appear here..." readonly></textarea>
                    </div>

                    <div class="form-control">
                        <label for="sbClaim">Content Certification with VaultMint™?</label>
                        <select id="sbClaim" name="claim">
                            <option value="yes">Yes — Activate certification</option>
                            <option value="no">No — Build only</option>
                        </select>
                    </div>

                    <button type="submit" class="form-action-button">Compile Module & Save</button>
                    <p class="text-gray-500 text-sm mt-4">Your module will be saved to your local ToyNest workspace with optional VaultMint™ certification.</p>
                </form>
            </div>
        </section>

        <section id="ecosystem-map-view" class="view view-hidden">
            <div class="panel">
                <h2 class="section-title text-center mb-12">Global Repository & Routing Structure</h2>
                <p class="section-intro mb-8">This section illustrates the precise, templated file path and repository structure for the entire FAA.Zone ecosystem. Click on a sector to expand its details and reveal the exact URLs. This structure guarantees consistency and automated deployment across all 7038+ digital assets.</p>
                
                <div id="sectorContainer" class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-lg shadow-2xl text-left">
                    <h3 class="text-xl font-bold mb-4 text-yellow-400">Explore File Paths by Sector:</h3>
                    <div class="space-y-3">
                        </div>
                </div>

                <div class="panel mt-8">
                    <h2 class="section-title text-center mb-12">Global Footer Repository: The Legal Standard</h2>
                    <p class="section-intro mb-8">The global footer, including all mandatory legal and ecosystem links, is managed from a single, dedicated repository. This ensures strict consistency, legal compliance, and branding integrity across every single page, brand, and subnode within the FAA.Zone.</p>
                    
                    <div class="max-w-3xl mx-auto bg-gray-800 p-6 rounded-lg shadow-2xl text-left">
                        <h3 class="text-xl font-bold mb-4 text-yellow-400">Conceptual `footer-global-repo` Structure:</h3>
                        <div class="copy-square">
                            <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">
/footer-global-repo/
├── src/
│   ├── components/
│   │   └── GlobalFooter.js  # Reusable footer component
│   └── styles/
│       └── footer.css       # Styling for the footer
├── public/
│   ├── privacy.html         # Content for /privacy route
│   ├── terms.html           # Content for /terms route
│   ├── contact.html         # Content for /contact route
│   ├── copyright.html       # Content for /copyright route
│   ├── developers.html      # Content for /developers route
│   ├── vaultmesh.html       # Content for /vaultmesh route
│   ├── fruitful.html        # Content for /fruitful route
│   ├── faa.zone.html        # Content for /faa.zone route
│   ├── about.html           # Content for /about route
│   └── accessibility.html   # Content for /accessibility route
└── package.json             # Build scripts for global deployment
                            </pre>
                        </div>
                        <p class="text-gray-400 text-sm">This repository is automatically integrated into every sector's build process, ensuring all sites adhere to the global footer mandate.</p>
                    </div>
                </div>
                
                <div class="panel mt-8">
                    <h2 class="section-title text-center mb-12">Global Payment & Checkout: Seamless Transactions</h2>
                    <p class="section-intro mb-8">Fruitful Global provides a unified, secure, and automated payment and checkout solution. Integrated with **VaultPay™** for secure transactions and **ClaimRoot™** for automated licensing, this system ensures a frictionless experience for both customers and partners globally. No payment-related troubleshooting needed; the logic is transparent and self-validating.</p>

                    <div class="max-w-2xl mx-auto bg-gray-800 p-8 rounded-lg shadow-2xl">
                        <h3 class="text-xl font-bold mb-6 text-yellow-400">Experience the Global Checkout Flow:</h3>
                        
                        <div id="checkout-step-1">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">1</span> Item Selection</h4>
                            <p class="text-gray-300 mb-4">Your selected item: **ToyNest™ Developer License**</p>
                            <p class="text-gray-300 mb-4">Price: **$9,999.00 USD** (One-time license fee)</p>
                            <button class="checkout-button" onclick="showCheckoutStep(2)">Proceed to Checkout</button>
                        </div>

                        <div id="checkout-step-2" class="hidden">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">2</span> Payment Information</h4>
                            <p class="text-gray-300 mb-4">Enter your secure payment details for **VaultPay™** processing.</p>
                            <input type="text" id="cardNumber" placeholder="Card Number (e.g., 4111 XXXX XXXX 1111)" class="checkout-input mb-3">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="text" id="expiryDate" placeholder="MM/YY" class="checkout-input">
                                <input type="text" id="cvc" placeholder="CVC" class="checkout-input">
                            </div>
                            <button class="checkout-button w-full" onclick="processPayment()">Process Payment via VaultPay™</button>
                            <p id="paymentStatus" class="text-red-400 mt-2 text-sm hidden">Payment processing...</p>
                        </div>

                        <div id="checkout-step-3" class="hidden">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">3</span> Order Confirmation & Licensing</h4>
                            <p class="text-gray-300 mb-4">Your order is confirmed! Licensing is being secured via **ClaimRoot™**.</p>
                            <p id="orderStatus" class="text-green-400 mb-4">Status: **Processing ClaimRoot™ License...**</p>
                            <button class="checkout-button w-full" onclick="resetCheckout()">Complete & Return to Dashboard</button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <section id="user-dashboards-view" class="view view-hidden">
            <div class="panel">
                <h2 class="section-title text-center mb-12">User Dashboards Overview</h2>
                <p class="section-intro mb-8">This section provides a conceptual overview of the various end-user and role-specific dashboards available within the Fruitful Smart Toys™ ecosystem. These are the interfaces designed for parents, caregivers, and children to interact with the smart toys and learning modules you develop.</p>

                <div class="panel bg-gray-900 border border-gray-700 mb-8">
                    <h3 class="text-yellow-400 mb-4">ModularView: Core Child Management Dashboards</h3>
                    <p class="text-gray-400 text-sm mb-6">ModularView is the central hub for parents to manage their child's learning, toy settings, and activities. It provides a holistic view of their child's engagement and progress.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-chart-line mr-2 text-blue-400"></i> Learning Progress</h4>
                            <p class="text-gray-400 text-sm">Track academic mastery and skill acquisition.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-cog mr-2 text-green-400"></i> Toy Settings</h4>
                            <p class="text-gray-400 text-sm">Modify interactive settings and controls.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-book-open mr-2 text-purple-400"></i> Learning Modules</h4>
                            <p class="text-gray-400 text-sm">Explore and assign various educational modules.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-users mr-2 text-yellow-400"></i> Parental Dashboard</h4>
                            <p class="text-gray-400 text-sm">Overall performance and activity logs.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-robot mr-2 text-red-400"></i> AI Feedback</h4>
                            <p class="text-gray-400 text-sm">Receive AI-driven insights on learning habits.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-bell mr-2 text-teal-400"></i> Notifications & Alerts</h4>
                            <p class="text-gray-400 text-sm">Stay updated on milestones and new content.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-family mr-2 text-orange-400"></i> Family Learning Experience</h4>
                            <p class="text-gray-400 text-sm">Integrate family interactions into learning.</p>
                        </div>
                    </div>
                    <a href="/sectors/education/smart-toys/modularview.html" target="_blank" class="form-action-button mt-6">
                        <i class="fas fa-external-link-alt mr-2"></i> Visit ModularView
                    </a>
                </div>

                <div class="panel bg-gray-900 border border-gray-700">
                    <h3 class="text-yellow-400 mb-4">Role-Specific Dashboards: Personalized Views for Caregivers</h3>
                    <p class="text-gray-400 text-sm mb-6">Tailored dashboards provide relevant information and controls for every individual involved in a child's care and development.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-female mr-2 text-pink-400"></i> Mother's Insight Hub</h4>
                            <p class="text-gray-400 text-sm">Emotional well-being, daily activities, social development.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-male mr-2 text-blue-400"></i> Father's Progress Monitor</h4>
                            <p class="text-gray-400 text-sm">Academic milestones, skill mastery, STEM engagement.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-user-friends mr-2 text-purple-400"></i> Parents' Collaborative View</h4>
                            <p class="text-gray-400 text-sm">Unified insights, shared settings, family activity planning.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-user-nurse mr-2 text-green-400"></i> Nanny's Daily Planner</h4>
                            <p class="text-gray-400 text-sm">Manage routines, track play sessions, log essential care.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-globe-europe mr-2 text-indigo-400"></i> Au Pair's Cultural Exchange Hub</h4>
                            <p class="text-gray-400 text-sm">Monitor language exposure and cultural learning.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-chalkboard-teacher mr-2 text-red-400"></i> Tutor's Academic Focus</h4>
                            <p class="text-gray-400 text-sm">Detailed insights into subject challenges and progress.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-baby mr-2 text-teal-400"></i> Babysitter's Quick Guide</h4>
                            <p class="text-gray-400 text-sm">Essential routines, emergency contacts, approved activities.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-hand-holding-heart mr-2 text-yellow-400"></i> Grandparents' Connection Portal</h4>
                            <p class="text-gray-400 text-sm">Simplified view of favorite activities and creative outputs.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-child mr-2 text-cyan-400"></i> Child's Own Activity View</h4>
                            <p class="text-gray-400 text-sm">Fun, simplified dashboard showing achievements and adventures.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-shield-alt mr-2 text-gray-400"></i> Guardian's Security & Privacy Hub</h4>
                            <p class="text-gray-400 text-sm">Advanced controls for data privacy and content filtering.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-calendar-alt mr-2 text-orange-400"></i> Family Learning Coordinator</h4>
                            <p class="text-gray-400 text-sm">Manage schedules and coordinate multi-child learning.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-white font-semibold mb-2"><i class="fas fa-star mr-2 text-purple-400"></i> Special Needs Support Dashboard</h4>
                            <p class="text-gray-400 text-sm">Customizable tracking for diverse learning needs.</p>
                        </div>
                    </div>
                    <a href="/sectors/education/smart-toys/family-dashboards.html" target="_blank" class="form-action-button mt-6">
                        <i class="fas fa-external-link-alt mr-2"></i> Explore All Family Dashboards
                    </a>
                </div>
            </div>
        </section>

        <section id="editor-workspace-view" class="view view-hidden">
            <div class="editor-container">
                <div class="editor-header">
                    <span id="currentProjectEditName">Content Editor</span>
                    <button class="text-white text-xl hover:text-gray-300" onclick="showView('projects')">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
                <div class="editor-content-area">
                    <div class="code-editor">
                        <h4 class="text-xl font-semibold mb-4 text-white">Edit Learning Module Code</h4>
                        <textarea id="editorHtmlCssCode" placeholder="Edit your Smart Toy learning module or content code here..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorRefineCodeBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Refine Code
                            </button>
                            <button type="button" id="editorExplainCodeBtn" class="form-action-button secondary text-xs px-3 py-2">
                                ✨ Explain Code
                            </button>
                            <button type="button" id="editorReviewCodeBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                ✨ Review Code
                            </button>
                        </div>
                        <p id="editorHtmlCssStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="editorHtmlCssExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="editorHtmlCssReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>

                        <h5 class="text-lg font-semibold mt-6 mb-2 text-white">AI Content Generation</h5>
                        <div class="form-control">
                            <label for="editorSectionTopicInput" class="text-white text-sm mb-1">Learning Content Topic</label>
                            <input type="text" id="editorSectionTopicInput" placeholder="e.g., Interactive Math Problem, Emotional Response Script" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorGenerateHeadlineBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Generate Headline
                            </button>
                            <button type="button" id="editorGenerateCTABtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Generate CTA
                            </button>
                            <button type="button" id="editorGenerateSectionContentBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Generate Section Content
                            </button>
                        </div>
                        <div class="form-control mt-4">
                            <label for="editorRephraseTextInput" class="text-white text-sm mb-1">Rephrase/Improve Text</label>
                            <textarea id="editorRephraseTextInput" rows="3" placeholder="Enter text to rephrase or improve..." class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm"></textarea>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorRephraseTextBtn" class="form-action-button text-xs px-3 py-2">
                                ✨ Rephrase/Improve
                            </button>
                        </div>
                        <p id="editorContentGenStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="editorGeneratedContentOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>
                    <div class="preview-area">
                        <h4 class="text-xl font-semibold mb-4 text-white">Live Preview</h4>
                        <iframe id="editorLivePreviewFrame" title="Live Preview"></iframe>
                    </div>
                </div>
                <div class="editor-actions flex justify-center w-full"> <button class="form-action-button secondary" onclick="updateEditorPreview()">Update Preview</button>
                    <button class="form-action-button" onclick="showCustomModal('Save Project', 'Project saved! (Simulation)')">Save Project</button>
                    <button class="form-action-button" onclick="showCustomModal('Deploy Project', 'Project deployed! (Simulation)')">Deploy Project</button>
                </div>
            </div>
        </section>


        <section id="templates-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-palette mr-2"></i> Select a Template</h3>
                <div id="templatesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>
        </section>

        <section id="licenses-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-file-contract mr-2"></i> My Smart Toy Certifications</h3>
                <p class="mb-4 text-gray-400">View and manage all your deployed and VaultMint™ certified smart toy content within the Fruitful Global network.</p>
                <div id="licensesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>

            <div class="panel">
                <h3><i class="fas fa-handshake mr-2"></i> SaaS Licensing Agreements</h3>
                <p class="mb-4 text-gray-400">Review and sign your SaaS licensing agreements with Fruitful Global via SecureSign™.</p>
                <div id="royaltyAgreementsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>
        </section>

        <section id="analytics-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-chart-line mr-2"></i> Engagement Analytics</h3>
                <p class="mb-4 text-gray-400">Insights into smart toy engagement and learning progress.</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="chart-container">
                        <canvas id="deploymentTrendsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="royaltyDistributionChart"></canvas>
                    </div>
                </div>

                <div class="panel">
                    <h4>Child Progress Metrics</h4>
                    <div class="chart-container">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="api-keys-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-key mr-2"></i> Consolidated API Key Index (Fruitful Global)</h3>
                <p class="mb-4 text-gray-400">This document provides a comprehensive list of all API keys and credentials identified across your provided canvases and chat interactions. It explicitly lists every canvas where each key was embedded or mentioned.</p>

                <div class="security-note">
                    <strong>Important Security Note:</strong> Directly embedding API keys and sensitive credentials in client-side HTML or JavaScript is generally not recommended for production environments. This exposes your keys, making them vulnerable to misuse. For deployed applications, it is strongly advised to use a secure backend server to proxy your API requests and manage these keys via environment variables or a dedicated secrets management system.
                </div>

                <table class="api-key-table">
                    <thead>
                        <tr>
                            <th>API/Service</th>
                            <th>Key/Credential Details</th>
                            <th>Embedded Locations</th>
                        </tr>
                    </thead>
                    <tbody id="apiKeysTableBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="settings-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-cog mr-2"></i> My Settings</h3>

                <div class="flex border-b border-gray-700 mb-6">
                    <button class="settings-tab-btn active" data-settings-tab="profile">Profile</button>
                    <button class="settings-tab-btn" data-settings-tab="preferences">Learning Preferences</button>
                    <button class="settings-tab-btn" data-settings-tab="security">Security</button>
                    <button class="settings-tab-btn" data-settings-tab="domains">Domain & Cloud Services</button>
                </div>

                <div id="settings-profile" class="settings-sub-view">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Profile</h4>
                        <div class="form-control">
                            <label for="displayName">Display Name</label>
                            <input type="text" id="displayName" value="ToyInnovator001">
                        </div>

                        <div class="form-control">
                            <label for="email">Email</label>
                            <input type="email" id="email" value="smarttoys.dev@example.com">
                        </div>

                        <button class="form-action-button" onclick="showCustomModal('Profile Updated!', 'Your display name and email have been saved.')">Update Profile</button>
                    </section>
                </div>

                <div id="settings-preferences" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Learning Preferences</h4>
                        <div class="form-control">
                            <label for="defaultRegion">Default Deployment Region</label>
                            <select id="defaultRegion">
                                <option value="global">Global Rollout</option>
                                <option value="local">Regional Pilot</option>
                                <option value="beta">Beta Testing Group</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label for="autoClaimSetting">Auto-Enable VaultMint™ on Certification?</label>
                            <select id="autoClaimSetting">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>

                        <button class="form-action-button" onclick="showCustomModal('Preferences Saved!', 'Your learning preferences have been updated.')">Save Preferences</button>
                    </section>
                </div>

                <div id="settings-security" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Security</h4>
                        <div class="form-control">
                            <label for="password">Change Password</label>
                            <input type="password" id="password" placeholder="New Password">
                        </div>

                        <div class="form-control">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm Password">
                        </div>

                        <button class="form-action-button" onclick="showCustomModal('Password Updated!', 'Your password has been changed securely.')">Update Password</button>
                    </section>
                </div>

                <div id="settings-domains" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700 mb-6">
                        <h4>DNS Zone Management (Cloudflare Integrated)</h4>
                        <p class="text-gray-400 text-sm mb-4">Manage your domain's DNS records (A, CNAME, MX, TXT) with direct Cloudflare integration.</p>
                        <table class="api-key-table mb-4">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Name</th>
                                    <th>Value</th>
                                    <th>TTL</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dnsRecordsTableBody">
                                </tbody>
                        </table>
                        <div class="flex flex-wrap items-center gap-2">
                             <input type="text" id="dnsRecordTypeInput" placeholder="DNS Type (e.g., A, CNAME, MX)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs max-w-[200px]">
                            <button class="form-action-button text-sm px-3 py-2 bg-purple-600 hover:bg-purple-700" id="explainDnsBtn">
                                ✨ Explain DNS Type
                            </button>
                            <button class="form-action-button text-sm px-3 py-2" onclick="showCustomModal('Add DNS Record', 'Add new DNS record functionality coming soon!')">
                                <i class="fas fa-plus mr-1"></i> Add Record
                            </button>
                        </div>
                        <p id="dnsExplainStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="dnsExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700 mb-6">
                        <h4>Domain Management (Vercel Integrated for Silent Deployments)</h4>
                        <p class="text-gray-400 text-sm mb-4">Manage your primary domains and add-on domains. Deployed silently via Vercel integration.</p>
                        <ul id="domainList" class="list-disc list-inside text-gray-200 mb-4">
                            <li><i class="fas fa-check-circle text-green-500 mr-2"></i> toynest.faa.zone (Primary)</li>
                            <li><i class="fas fa-check-circle text-green-500 mr-2"></i> learncomp.toynest.faa.zone (Subdomain)</li>
                            </ul>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="newDomainName" placeholder="Add New Domain (e.g., newtoy.com)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <button class="form-action-button text-sm px-3 py-2" onclick="showCustomModal('Add Domain', 'Adding domain functionality coming soon!')">
                                <i class="fas fa-plus mr-1"></i> Add Domain
                            </button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <input type="text" id="newAddonDomainName" placeholder="Add Add-on Domain (e.g., arbooks.newtoy.com)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <select id="addonDomainTarget" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                                <option value="">Select Primary Domain</option>
                                <option value="toynest.faa.zone">toynest.faa.zone</option>
                            </select>
                            <button class="form-action-button text-sm px-3 py-2" onclick="showCustomModal('Add Add-on Domain', 'Adding add-on domain functionality coming soon!')">
                                <i class="fas fa-plus mr-1"></i> Add Add-on
                            </button>
                        </div>
                        <button class="form-action-button mt-4 bg-blue-600 hover:bg-blue-700" onclick="showCustomModal('Silent Deploy Initiated', 'Initiating silent deployment across Cloudflare and Vercel...')">
                            <i class="fas fa-cloud-upload-alt mr-1"></i> Deploy in Silence
                        </button>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Email Accounts (Powered by Zoho Mail)</h4>
                        <p class="text-gray-400 text-sm mb-4">Create and manage email accounts for your domains.</p>
                        <table class="api-key-table mb-4">
                            <thead>
                                <tr>
                                    <th>Email Address</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="emailAccountsTableBody">
                                </tbody>
                        </table>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="newEmailPrefix" placeholder="New email (e.g., learning)" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <span class="text-gray-200">@</span>
                            <input type="text" id="newEmailDomain" placeholder="yourdomain.com" value="toynest.faa.zone" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <button class="form-action-button text-sm px-3 py-2" id="createEmailBtn">
                                <i class="fas fa-plus mr-1"></i> Create Email
                            </button>
                        </div>
                        <p id="emailDraftStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700 mt-8">
                        <h4 class="text-yellow-400 mb-4">Company Infrastructure Setup & Details</h4>
                        <p class="text-gray-300 mb-4">Access the comprehensive setup details for any company. Select a company below to reveal its granular configurations. **No troubleshooting or helpline needed**.</p>
                        
                        <div id="settingsCompanySelectionGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                            </div>

                        <div id="settingsCompanyDetailsOutput" class="company-details-section hidden">
                            </div>
                    </section>

                </div>

                <p class="text-gray-500 text-sm mt-4">All changes are synced to your Fruitful Global vault and stored with encrypted ClaimRoot credentials.</p>
            </div>
        </section>

        <section id="login-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-sign-in-alt mr-2"></i> Sign In to ToyNest™</h3>
                <form id="loginForm">
                    <div class="form-control">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" value="smarttoys.dev@example.com" required>
                    </div>
                    <div class="form-control">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="••••••••" value="password123" required>
                    </div>
                    <button type="submit" class="form-action-button">Login</button>
                    <p class="text-gray-500 text-sm mt-4">Don't have an account? <a href="#signup" class="text-blue-500 hover:underline" onclick="showView('signup')">Sign Up</a></p>
                </form>
            </div>
        </section>

        <section id="signup-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-user-plus mr-2"></i> Join ToyNest™</h3>
                <form id="signupForm">
                    <div class="form-control">
                        <label for="signupName">Display Name</label>
                        <input type="text" id="signupName" placeholder="Your Developer Name" required>
                    </div>
                    <div class="form-control">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-control">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="••••••••" required>
                    </div>
                    <div class="form-control">
                        <label for="signupConfirmPassword">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="form-action-button">Sign Up</button>
                    <p class="text-gray-500 text-sm mt-4">Already have an account? <a href="#login" class="text-blue-500 hover:underline" onclick="showView('login')">Sign In</a></p>
                </form>
            </div>
        </section>
    </main>

    <div id="templatePreviewModal" class="custom-modal-overlay">
        <div class="custom-modal-content max-w-4xl w-full h-auto" style="padding: 0; text-align: left;">
            <div class="template-preview-header">
                <h3 id="templatePreviewTitle"></h3>
                <button class="close-preview-btn" onclick="hideTemplatePreviewModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <iframe id="templatePreviewFrame" class="template-preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
                <p id="templatePreviewDescription" class="text-gray-400 text-sm mt-2"></p>
                <div class="template-preview-actions">
                    <button class="btn-primary" id="useTemplateNewProjectBtn"><i class="fas fa-plus-circle mr-2"></i> Use in New Project</button>
                    <button class="btn-secondary" id="useTemplateScrollBuilderBtn"><i class="fas fa-tools mr-2"></i> Use in Content Builder</button>
                </div>
            </div>
        </div>
    </div>

    <div id="simplifyAgreementModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="simplifyAgreementTitle">Simplified Agreement</h3>
                <button class="close-preview-btn" onclick="hideSimplifyAgreementModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <p id="simplifiedAgreementText" class="text-gray-700 text-left whitespace-pre-wrap leading-relaxed"></p>
                <div class="template-preview-actions">
                    <button class="btn-secondary" onclick="hideSimplifyAgreementModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="projectIdeaModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="projectIdeaModalTitle">AI Project Idea</h3>
                <button class="close-preview-btn" onclick="hideProjectIdeaModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p class="text-gray-400 text-sm mb-2">Review the AI-generated idea below:</p>
                <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                    <p class="text-gray-200 mb-2"><strong>Project Name:</strong> <span id="ideaProjectName"></span></p>
                    <p class="text-gray-200 mb-2"><strong>Description:</strong> <span id="ideaProjectDescription"></span></p>
                    <p class="text-gray-200"><strong>Suggested Template:</strong> <span id="ideaSuggestedTemplate"></span></p>
                </div>
                <div class="template-preview-actions">
                    <button class="btn-primary" id="applyProjectIdeaBtn"><i class="fas fa-check-circle mr-2"></i> Apply Idea to Form</button>
                    <button class="btn-secondary" onclick="hideProjectIdeaModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="projectSummaryModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="projectSummaryTitle">Project Summary</h3>
                <button class="close-preview-btn" onclick="hideProjectSummaryModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <p id="projectSummaryText" class="text-gray-700 text-left whitespace-pre-wrap leading-relaxed"></p>
                <div class="template-preview-actions">
                    <button class="btn-secondary" onclick="hideProjectSummaryModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="emailDraftModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="emailDraftTitle">Draft Email</h3>
                <button class="close-preview-btn" onclick="hideEmailDraftModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p class="text-gray-400 text-sm mb-2">To: <span id="emailDraftTo"></span></p>
                <div class="form-control">
                    <label for="emailPurposeInput" class="text-white text-sm mb-1">Purpose of Email</label>
                    <input type="text" id="emailPurposeInput" placeholder="e.g., Welcome new user, Support query, Marketing announcement" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                </div>
                <button type="button" id="generateEmailDraftBtn" class="form-action-button text-xs px-3 py-2">
                    ✨ Generate Draft
                </button>
                <p id="emailDraftStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                <textarea id="generatedEmailDraftOutput" rows="10" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2" placeholder="Your AI-generated email draft will appear here..." readonly></textarea>
                <div class="template-preview-actions">
                    <button class="btn-primary" onclick="document.execCommand('copy'); showCustomModal('Email Copied', 'Email draft copied to clipboard!', true);">Copy to Clipboard</button>
                    <button class="btn-secondary" onclick="hideEmailDraftModal()">Close</button>
                </div>
            </div>
        </div>
    </div>


    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-xl text-center max-w-sm">
            <p id="customModalMessage"></p>
        </div>
    </div>

    <script>
        // Data for Smart Toys from your provided HTML
        const smartToySubBrandsRaw = [
            "Smart Learning Companions",
            "Speech Recognition Engine",
            "Core Subjects: Math, Science, Literacy",
            "Emotional Intelligence & Storytelling",
            "Interactive Holographic Story Units",
            "Smart Pens with Adaptive AI Feedback",
            "AR-Enhanced Interactive Books",
            "Gamified Educational Apps",
            "Multilingual Framework",
            "AI Parental Dashboard",
            "FAA VaultMint™ Certified",
            "OmniScroll + Infinite Ledger Ready"
        ];

        // Brands from the second provided HTML, assumed to be part of Education & Youth
        const otherEducationBrandsRaw = [
            "BrightMinds Institute", "NextWave Learning", "Elevate Academy", "NovaEdge Schools",
            "YouthQuest Alliance", "EduSphere Global", "OpenFuture Campus", "KinderNest Systems",
            "TalentBloom Initiative", "LearnLoop Foundation", "SkillSpring Academies", "GrowGrid Labs",
            "BeaconBridge Schools", "QuantumEdu Nexus", "PolyLearn Group", "YouthLine Academy",
            "OpenKnowledge Core", "YoungGenius Hub", "Educatalyst Engine", "DreamBuild Institute",
            "FutureSteps Labs", "Kidspire Solutions", "NeoEdu Chain", "CloudMind Learning",
            "SparkQuest Network", "ProdigyLink Schools", "SafeStart Education", "VaultED Foundation",
            "OmniMind Academy", "LeapNode Schools", "EduOrbit Center", "Mindwave Institute",
            "LearnSync Systems", "NurtureLine Schools", "BloomStep EduNet", "YouthDelta Project",
            "SkillNest Alliance", "EduPilot Grid", "VaultNest Learning", "ThinkGrow Systems",
            "OpenYouth Exchange", "QuantumSteps Academy", "BrightArc Eduware", "GenEd Frontier",
            "MindHatch Network", "NetLearn Institute"
        ];

        // Format into the `brands` array for education-youth sector
        const educationYouthBrandsFormatted = [
            { name: "Fruitful Smart Toys", subnodes: smartToySubBrandsRaw }
        ].concat(otherEducationBrandsRaw.map(brandName => ({ name: brandName, subnodes: [] })));


        // --- Centralized Data Store for CodeNest Dashboard ---
        const sectorList = {
            "agriculture": { name: "🌱 Agriculture & Biotech" },
            "fsf": { name: "🥦 Food, Soil & Farming" },
            "banking": { name: "🏦 Banking & Finance" },
            "creative": { name: "🖋️ Creative Tech" },
            "logistics": { name: "📦 Logistics & Packaging" },
            "education-ip": { name: "📚 Education & IP" }, // Intellectual Property focus
            "fashion": { name: "✂ Fashion & Identity" },
            "gaming": { name: "🎮 Gaming & Simulation" },
            "health": { name: "🧠 Health & Hygiene" },
            "housing": { name: "🏗️ Housing & Infrastructure" },
            "justice": { name: "⚖ Justice & Ethics" },
            "knowledge": { name: "📖 Knowledge & Archives" },
            "micromesh": { name: "☰ Micro-Mesh Logistics" },
            "media": { name: "🎬 Motion, Media & Sonic" },
            "nutrition": { name: "✿ Nutrition & Food Chain" },
            "ai-logic": { name: "🧠 AI, Logic & Grid" },
            "packaging": { name: "📦 Packaging & Materials" },
            "quantum": { name: "✴️ Quantum Protocols" },
            "ritual": { name: "☯ Ritual & Culture" },
            "saas": { name: "🔑 SaaS & Licensing" },
            "trade": { name: "🧺 Trade Systems" },
            "utilities": { name: "🔋 Utilities & Energy" },
            "voice": { name: "🎙️ Voice & Audio" },
            "webless": { name: "📡 Webless Tech & Nodes" },
            "nft": { name: "🔁 NFT & Ownership" },
            "education-youth": { name: "🎓 Education & Youth" }, // Specific for youth/smart toys
            "zerowaste": { name: "♻️ Zero Waste" },
            "professional": { name: "🧾 Professional Services" },
            "payroll-mining": { name: "🪙 Payroll Mining & Accounting" },
            "mining": { name: "⛏️ Mining & Resources" },
            "wildlife": { name: "🦁 Wildlife & Habitat" },
            "admin-panel": { name: "⚙️ CodeNest™ Central Hub" }
        };


        const allSectorsData = {
            "admin-panel": {
                name: "⚙️ CodeNest™ Central Hub",
                repoName: "codenest-global-admin",
                baseUrl: "codenest.faa.zone",
                brands: [
                    { name: "Core Services", subnodes: ["Project Management", "License Vault", "Deployment Pipelines", "User Access"] },
                    { name: "System Monitoring", subnodes: ["Health Dashboard", "Log Analysis", "Traffic Insights"] }
                ]
            },
            "education-youth": { // Updated to include Smart Toys and other education brands
                name: "🎓 Education & Youth",
                repoName: "education-youth-seedwave-admin",
                baseUrl: "education-youth.seedwave.faa.zone",
                brands: educationYouthBrandsFormatted
            },
            "mining": {
                name: "⛏️ Mining & Resources",
                repoName: "mining-seedwave-admin",
                baseUrl: "mining.seedwave.faa.zone",
                brands: [
                    { name: "MineNest", subnodes: ["NestTrack", "VaultShaft", "QRMine", "ClaimGrid"] },
                    { name: "DrillCoreX", subnodes: ["CoreDrop", "PulsePath", "OreTrace", "DrillYield"] },
                    { name: "OreSync", subnodes: ["SyncRock", "VaultEcho", "QRDrill", "ClaimTag"] },
                    { name: "VaultRock", subnodes: ["RockBeam", "MineLoop", "SignalTrace", "QRClaim"] },
                    { name: "ClaimMine", subnodes: ["ClaimOre", "VaultPath", "OrePing", "MineSignal"] },
                    { name: "TrackShaft", subnodes: ["ShaftMesh", "DropMine", "TrackSeam", "QRTrack"] },
                    { name: "PulseMine", subnodes: ["PulseCrate", "MineEcho", "YieldDrill", "GridTag"] },
                    { name: "CoreBeam", subnodes: ["BeamPath", "ClaimRock", "VaultLoop", "SeamDrop"] },
                    { name: "DigEcho", subnodes: ["EchoMine", "RockPing", "VaultTrace", "ClaimBeam"] },
                    { name: "RockPath", subnodes: ["PathDrop", "GridMine", "QRNode", "YieldOre"] },
                    { name: "YieldDrill", subnodes: ["DrillGrid", "ClaimYield", "SyncTunnel", "OreEcho"] },
                    { name: "MineProof", subnodes: ["ProofMine", "SeamCast", "VaultGrid", "DropCrate"] },
                    { name: "OreLine", subnodes: ["OreLineX", "VaultDrill", "MineForm", "TagTrace"] },
                    { name: "DrillLink", subnodes: ["LinkMine", "PulseEcho", "GridSeam", "YieldCast"] },
                    { name: "VaultTunnel", subnodes: ["TunnelSync", "ClaimLoop", "QRDrillX", "OreBeam"] },
                    { name: "GeoGrid", subnodes: ["GridGeo", "VaultMap", "RockForm", "ClaimTunnel"] },
                    { name: "SeamSync", subnodes: ["SeamSyncX", "OreDrop", "QRMineX", "DrillMark"] },
                    { name: "ClaimOre", subnodes: ["ClaimOreX", "TrackGrid", "VaultDrop", "PingEcho"] },
                    { name: "PulseBlast", subnodes: ["BlastMine", "PulsePing", "QRPath", "SeamMark"] },
                    { name: "OreEcho", subnodes: ["EchoRock", "YieldTrack", "VaultBeam", "ClaimSync"] },
                    { name: "DeepCrate", subnodes: ["CrateDrop", "SyncClaim", "DrillForm", "TunnelMap"] },
                    { name: "RockLogic", subnodes: ["RockLogicX", "VaultOre", "YieldLoop", "PingDrill"] },
                    { name: "CoreDrill", subnodes: ["CoreMine", "OreTag", "VaultPing", "GridTrack"] },
                    { name: "MineCast", subnodes: ["MineCastX", "ClaimNest", "QRTrace", "YieldEcho"] },
                    { name: "DrillMark", subnodes: ["DrillMarkX", "OreSignal", "VaultCrate", "PingTag"] },
                    { name: "SignalOre", subnodes: ["OreSignalX", "GridEcho", "ClaimDrop", "TrackTunnel"] },
                    { name: "YieldTrack", subnodes: ["TrackYield", "MineFrame", "SignalGrid", "EchoDrill"] },
                    { name: "VaultSeam", subnodes: ["VaultSeamX", "QRClaimX", "GridOre", "TunnelEcho"] },
                    { name: "ShaftDrop", subnodes: ["DropShaft", "ClaimTunnelX", "YieldDrillX", "VaultGrid"] },
                    { name: "GeoNode", subnodes: ["GeoNodeX", "SignalPing", "DropEcho", "MineLink"] }
                ]
            },
            // Other sectors are omitted for brevity in this dashboard, but conceptually exist.
        };


        const companyData = {
            "smarttoys-pty": {
                name: "Fruitful Smart Toys (Pty) Ltd",
                sector_key: "education-youth",
                details: {
                    "Location": "Cape Town, South Africa",
                    "CEO": "Dr. Anya Sharma",
                    "Primary Contact": "info@smarttoys.faa.zone",
                    "Deployment Servers": "Global (Managed by ToyNest™)",
                    "Active Certifications": "VaultMint™ Gold Standard",
                    "Compliance Standards": "COPPA, GDPR-K, ISO 27001",
                    "Security Audit": "Annual (Last: Q1 2025)",
                    "System Uptime (YTD)": "99.999%",
                    "VaultMesh Integration": "Full",
                    "ClaimRoot Integration": "Full"
                }
            },
            "kindernest-systems": {
                name: "KinderNest Systems Inc.",
                sector_key: "education-youth",
                details: {
                    "Location": "Silicon Valley, USA",
                    "CEO": "Mark Chen",
                    "Primary Contact": "support@kindernest.com",
                    "Deployment Servers": "North America (Cloud-based)",
                    "Active Certifications": "VaultMint™ Bronze Standard",
                    "Compliance Standards": "COPPA",
                    "Security Audit": "Bi-annual",
                    "System Uptime (YTD)": "99.8%",
                    "VaultMesh Integration": "Partial",
                    "ClaimRoot Integration": "Enabled"
                }
            },
            "minenest-corp": { // Existing mining company (for settings view context)
                name: "MineNest Corporation",
                sector_key: "mining",
                details: {
                    "Location": "Johannesburg, South Africa",
                    "CEO": "Thabo Ntlatleng",
                    "Primary Contact": "operations@minenest.com",
                    "Deployment Servers": "Africa (Managed by MineNest™)",
                    "Active Licenses": "All Mining & Resources Protocols",
                    "Compliance Standards": "ISO 14001, OHSAS 18001",
                    "Security Audit": "Bi-annual (Last: Q2 2025)",
                    "System Uptime (YTD)": "99.998%",
                    "VaultMesh Integration": "Full",
                    "ClaimRoot Integration": "Full"
                }
            },
            "drillcorex-ltd": { // Existing mining company (for settings view context)
                name: "DrillCoreX Ltd.",
                sector_key: "mining",
                details: {
                    "Location": "Perth, Australia",
                    "CEO": "Sarah O'Connell",
                    "Primary Contact": "support@drillcorex.com",
                    "Deployment Servers": "Asia-Pacific (Cloud-based)",
                    "Active Licenses": "DrillCoreX, CoreDrop",
                    "Compliance Standards": "Australian Mining Regs",
                    "Security Audit": "Annual",
                    "System Uptime (YTD)": "99.8%",
                    "VaultMesh Integration": "Partial",
                    "ClaimRoot Integration": "Enabled"
                }
            }
        };

        const appData = {
            user: {
                displayName: "ToyInnovator001",
                email: "smarttoys.dev@example.com",
                defaultRegion: "global",
                autoClaim: "yes"
            },
            dashboard: {
                totalProjects: 520, // Total active smart toy engagements
                liveScrolls: 380,   // Learning modules currently engaged
                monthlyRoyalties: 120, // VaultMint Certifications completed
                systemHealth: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Child Engagement Rate (%)',
                        data: [75, 80, 85, 82, 88, 90, 92, 95, 93, 96, 98, 99],
                        borderColor: 'rgba(0, 113, 227, 0.8)', // Blue
                        backgroundColor: 'rgba(0, 113, 227, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Learning Progress Index',
                        data: [50, 55, 60, 62, 65, 70, 75, 78, 80, 83, 85, 88],
                        borderColor: 'rgba(250, 204, 21, 0.8)', // Yellow
                        backgroundColor: 'rgba(250, 204, 21, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            },
            projects: [], // Will be populated with thousands of mock projects
            projectLoadIndex: 0,
            projectsPerLoad: 12, // Number of projects to load at once

            licenses: [
                { id: 'TOY-001', name: 'Smart Learning Companions Dev License', region: 'Global Rollout', royalty: 'VaultMint™ Gold', activationDate: '2025-01-10', claimStatus: 'Certified', verified: true, editorLink: '#' },
                { id: 'TOY-002', name: 'Holographic Story Unit Content License', region: 'Regional Pilot', royalty: 'VaultMint™ Silver', activationDate: '2025-02-01', claimStatus: 'Pending Certification', verified: false, editorLink: '#' },
                { id: 'TOY-003', name: 'Speech Recognition Engine SDK', region: 'Global Rollout', royalty: 'VaultMint™ Platinum', activationDate: '2025-03-15', claimStatus: 'Certified', verified: true, editorLink: '#' },
                { id: 'TOY-004', name: 'AR-Enhanced Books Publishing Rights', region: 'Beta Testing', royalty: 'VaultMint™ Bronze', activationDate: '2025-04-01', claimStatus: 'Draft', verified: false, editorLink: '#' },
            ],
            templates: [
                { name: 'Interactive Phonics Module', description: 'Template for creating engaging, AI-powered phonics lessons.', link: '#', icon: 'fas fa-lightbulb',
                    previewHtml: `
                        <div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                            <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">ToyNest™ | <span style="color: #facc15;">Phonics Play</span></h1>
                            <h2 style="font-size: 1.2rem; color: #424245; margin-bottom: 1.5rem;">AI-Guided Reading Fun</h2>
                            <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Help children master reading with interactive sounds and word games.</p>
                            <button style="background-color: #facc15; color: black; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">Start Lesson</button>
                        </div>
                    `
                },
                { name: 'Emotional Storytelling Narrative', description: 'Framework for interactive stories that teach emotional intelligence.', link: '#', icon: 'fas fa-heart',
                    previewHtml: `
                        <div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                            <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">ToyNest™ | <span style="color: #facc15;">Empathy Tales</span></h1>
                            <h2 style="font-size: 1.2rem; color: #424245; margin-bottom: 1.5rem;">Grow Emotional Intelligence</h2>
                            <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Stories that adapt to teach empathy and social awareness through child's choices.</p>
                            <button style="background-color: #facc15; color: black; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">Read Story</button>
                        </div>
                    `
                },
                { name: 'Gamified Math Adventure', description: 'Design a game-based module for core math subjects with adaptive difficulty.', link: '#', icon: 'fas fa-calculator',
                    previewHtml: `
                        <div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                            <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">ToyNest™ | <span style="color: #facc15;">Math Quest</span></h1>
                            <h2 style="font-size: 1.2rem; color: #424245; margin-bottom: 1.5rem;">Adventure in Numeracy</h2>
                            <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Solve puzzles, collect gems, and conquer math challenges in an exciting game world.</p>
                            <button style="background-color: #facc15; color: black; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">Play Game</button>
                        </div>
                    `
                },
                { name: 'AI Parental Dashboard Layout', description: 'Standard layout for displaying child progress, engagement, and AI insights.', link: '#', icon: 'fas fa-chart-bar',
                    previewHtml: `
                        <div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                            <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">ToyNest™ | <span style="color: #facc15;">Parental Hub</span></h1>
                            <h2 style="font-size: 1.2rem; color: #424245; margin-bottom: 1.5rem;">Insights into Child's Growth</h2>
                            <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Access real-time reports on academic, emotional, and social development.</p>
                            <button style="background-color: #facc15; color: black; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">View Dashboard</button>
                        </div>
                    `
                },
            ],
            analytics: {
                deploymentTrends: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New Learning Modules Deployed',
                        data: [25, 30, 35, 32, 40, 45],
                        borderColor: 'rgba(0, 113, 227, 0.8)',
                        backgroundColor: 'rgba(0, 113, 227, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                royaltyDistribution: {
                    labels: ['Speech Recognition', 'Holographic Units', 'AR Books', 'Gamified Apps', 'Smart Pens'],
                    datasets: [{
                        data: [30, 25, 20, 15, 10],
                        backgroundColor: ['#facc15', '#0071e3', '#30d158', '#f59e0b', '#6e6e73'],
                        hoverOffset: 4
                    }]
                },
                userActivity: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Active Smart Toys (Daily Average)',
                        data: [300, 350, 330, 380, 400, 250, 200],
                        borderColor: 'rgba(0, 113, 227, 0.8)',
                        backgroundColor: 'rgba(0, 113, 227, 0.1)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Learning Hours (Thousands)',
                        data: [15, 18, 17, 20, 22, 10, 8],
                        borderColor: 'rgba(250, 204, 21, 0.8)',
                        backgroundColor: 'rgba(250, 204, 21, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                }
            },
            apiKeys: [
                { service: "Speech-to-Text API (Child Voice)", key: "STTAPIXYZ789", locations: ["Speech Recognition Engine"] },
                { service: "AI Cognitive Feedback Engine", key: "COGAIKEY123DEF", locations: ["Smart Learning Companions", "AI Parental Dashboard"] },
                { service: "Holographic Projection SDK", key: "HOLOVIEWABC987", locations: ["Interactive Holographic Story Units"] },
                { service: "AR Core Development Kit", key: "ARCDK456LMN", locations: ["AR-Enhanced Interactive Books"] },
                { service: "VaultMint™ Certification API", key: "VAULTMINTCERTKEY", locations: ["FAA VaultMint™ Certified"] }
            ],
            royaltyAgreements: [
                { id: 'SAAS-001-TOY', name: 'Smart Toys OmniSaaS Licensing Agreement', status: 'Signed', link: '#', description: 'Standard agreement for OmniSaaS deployment of Smart Toys content.' },
                { id: 'SAAS-002-HOLO', name: 'Holographic Unit Content Distribution Treaty', status: 'Pending Signature', link: '#', description: 'Specialized agreement for content distribution via holographic units.' },
                { id: 'SAAS-003-AI', name: 'AI Learning Algorithm Partnership', status: 'Signed', link: '#', description: 'Agreement for integration and revenue sharing from AI adaptive learning algorithms.' }
            ],
            // Add static color references here for Chart.js
            colors: {
                primary: null, secondary: null, textDark: null, borderColorDark: null, accentGold: null
            },
            // NEW: Domain and DNS Data
            dnsRecords: [
                { type: 'A', name: '@', value: '203.0.113.45', ttl: 'Auto' },
                { type: 'CNAME', name: 'www', value: '@', ttl: 'Auto' },
                { type: 'MX', name: '@', value: 'mail.toynest.faa.zone (Priority 10)', ttl: 'Auto' },
                { type: 'TXT', name: '@', value: 'v=spf1 include:toynest.faa.zone ~all', ttl: 'Auto' },
            ],
            emailAccounts: [
                { email: 'support@toynest.faa.zone', status: 'Active' },
                { email: 'sales@toynest.faa.zone', status: 'Active' },
                { email: 'developers@toynest.faa.zone', status: 'Suspended' },
            ],
            domains: [
                { name: 'toynest.faa.zone', type: 'Primary' },
                { name: 'smarttoys.faa.zone', type: 'Redirect' }, // Add redirect for original domain
                { name: 'holograph.toynest.faa.zone', type: 'Subdomain' },
            ],
        };

        // Adding mock HTML content to projects for editor integration
        appData.projects = Array.from({ length: 520 }).map((_, i) => {
            const statuses = ['live', 'pending', 'draft', 'error'];
            const regions = ['Global Rollout', 'Regional Pilot', 'Beta Testing Group'];
            const types = ['AI Language Companion', 'Holographic Story Unit', 'AR Interactive Book', 'Gamified Learning App', 'Smart Pen Module'];
            
            const id = `TOY-${1000 + i}`;
            const name = `${types[Math.floor(Math.random() * types.length)]} - ${i + 1}`;
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            const region = regions[Math.floor(Math.random() * regions.length)];
            const royalty = `VaultMint™ ${['Gold', 'Silver', 'Bronze'][Math.floor(Math.random() * 3)]}`; 
            const lastActivity = new Date(Date.now() - Math.random() * 60 * 24 * 60 * 60 * 1000).toLocaleDateString(); // Last 60 days

            let htmlContent = '';
            if (name.includes('Holographic Story Unit')) {
                htmlContent = `
<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">ToyNest™ | <span style="color: #facc15;">HoloTales</span></h1>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">An interactive holographic storytelling experience for young learners.</p>
    <img src="https://placehold.co/400x200/facc15/000000?text=Hologram+Scene" alt="Hologram Scene" style="width: 100%; max-width: 400px; margin-top: 1.5rem; border-radius: 4px;">
</div>
                `;
            } else if (name.includes('AR Interactive Book')) {
                 htmlContent = `
<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">ToyNest™ | <span style="color: #facc15;">AR-Reads</span></h1>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Augmented Reality experiences bring stories to life on the page.</p>
    <img src="https://placehold.co/400x200/0071e3/FFFFFF?text=AR+Book+View" alt="AR Book View" style="width: 100%; max-width: 400px; margin-top: 1.5rem; border-radius: 4px;">
</div>
               `;
            } else if (name.includes('Gamified Learning App')) {
                htmlContent = `
<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">ToyNest™ | <span style="color: #facc15;">Play & Learn Quest</span></h1>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">Educational challenges embedded in an engaging adventure game.</p>
    <img src="https://placehold.co/400x200/facc15/000000?text=Game+Screen" alt="Game Screen" style="width: 100%; max-width: 400px; margin-top: 1.5rem; border-radius: 4px;">
</div>
                `;
            } else {
                htmlContent = `
<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #0071e3; margin-bottom: 1rem;">ToyNest™ | <span style="color: #facc15;">${name}</span></h1>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #6e6e73;">This is a new smart toy project created for enhanced child learning experiences.</p>
</div>
                `;
            }
            return { id, name, status, region, royalty, lastActivity, htmlCode: htmlContent };
        });


        // --- Utility Functions ---

        // Global functions must be attached to window to be called by inline onclicks
        window.showCustomModal = function(title, message, autoDismiss = true) {
            const modal = document.getElementById('customModal');
            const modalMessage = modal.querySelector('p');
            if (modal && modalMessage) {
                modalMessage.innerHTML = `<strong>${title}</strong><br>${message}`;
                modal.classList.remove('hidden');
                if (autoDismiss) {
                    setTimeout(() => {
                        window.hideCustomModal();
                    }, 3000);
                }
            }
        };

        window.hideCustomModal = function() {
            document.getElementById('customModal')?.classList.add('hidden');
        };

        // --- Checkout Flow Functions ---
        window.showCheckoutStep = function(step) {
            // Hide all checkout steps
            document.querySelectorAll('[id^="checkout-step-"]').forEach(el => {
                el.classList.add('hidden');
            });
            // Show the requested step
            document.getElementById(`checkout-step-${step}`)?.classList.remove('hidden');
            // Reset payment status message
            document.getElementById('paymentStatus')?.classList.add('hidden');
            document.getElementById('orderStatus')?.classList.add('hidden');
        };

        window.processPayment = function() {
            const paymentStatus = document.getElementById('paymentStatus');
            const orderStatus = document.getElementById('orderStatus');
            paymentStatus.textContent = "Processing payment...";
            paymentStatus.classList.remove('hidden');
            
            // Simulate payment processing
            setTimeout(() => {
                paymentStatus.textContent = "Payment successful! Initiating ClaimRoot™ license...";
                paymentStatus.classList.add('text-green-400');
                paymentStatus.classList.remove('text-red-400'); // Ensure it's green
                window.showCheckoutStep(3); // Move to confirmation step
                orderStatus.textContent = "Status: ClaimRoot™ License Activated!";
                orderStatus.classList.remove('hidden');
            }, 2000);
        };

        window.resetCheckout = function() {
            window.showCheckoutStep(1); // Reset to first step
            document.getElementById('cardNumber').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('cvc').value = '';
            document.getElementById('paymentStatus').classList.add('hidden');
            document.getElementById('orderStatus').classList.add('hidden');
            document.getElementById('paymentStatus').classList.remove('text-green-400');
            document.getElementById('paymentStatus').classList.add('text-red-400'); // Reset to red for future errors
            showView('dashboard'); // Optionally go back to dashboard
        };


        // --- View Management (Client-side Router) ---
        let currentChartInstances = {}; // To store Chart.js instances for destruction

        function showView(viewId) {
            // Update URL hash
            window.location.hash = viewId;

            // Hide all views
            document.querySelectorAll('.main-content .view').forEach(view => {
                view.classList.add('view-hidden');
            });
            // Show the requested view
            document.getElementById(`${viewId}-view`)?.classList.remove('view-hidden');

            // Update active state in sidebar nav
            document.querySelectorAll('.sidebar .nav-list a').forEach(link => {
                if (link.getAttribute('data-view') === viewId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Handle view-specific rendering
            renderViewContent(viewId);
        }

        function renderViewContent(viewId) {
            // Destroy existing charts to prevent canvas errors on view change
            for (const chartId in currentChartInstances) {
                if (currentChartInstances[chartId]) {
                    currentChartInstances[chartId].destroy();
                    currentChartInstances[chartId] = null;
                }
            }

            if (viewId === 'dashboard') {
                updateDashboardMetrics();
                renderSystemHealthChart();
            } else if (viewId === 'projects') {
                appData.projectLoadIndex = 0; // Reset load index when entering projects view
                renderProjects();
            } else if (viewId === 'ecosystem-map') {
                renderEcosystemMap(); // NEW: Render the ecosystem map
            } else if (viewId === 'user-dashboards') { // NEW: Render user dashboards overview
                renderUserDashboardsOverview();
            }
            else if (viewId === 'global-checkout') {
                window.showCheckoutStep(1); // Start checkout at step 1
            }
            else if (viewId === 'templates') {
                renderTemplates(); // Ensure templates are rendered
            } else if (viewId === 'licenses') {
                renderLicenses();
                renderRoyaltyAgreements(); // Render new section
            } else if (viewId === 'analytics') {
                renderAnalyticsCharts();
            } else if (viewId === 'api-keys') {
                renderApiKeysTable();
            } else if (viewId === 'settings') {
                loadSettings();
                showSettingsTab('profile'); // Default to profile tab when entering settings
            } else if (viewId === 'login' || viewId === 'signup') {
                // Clear forms on view change
                document.getElementById('loginForm')?.reset();
                document.getElementById('signupForm')?.reset();
            }
        }

        // --- Dashboard Specific Logic ---
        function updateDashboardMetrics() {
            document.getElementById('totalProjectsCount').textContent = appData.dashboard.totalProjects.toLocaleString();
            document.getElementById('liveScrollsCount').textContent = appData.dashboard.liveScrolls.toLocaleString();
            document.getElementById('monthlyRoyalties').textContent = appData.dashboard.monthlyRoyalties.toLocaleString(); // Display as number, not currency
        }

        function renderSystemHealthChart() {
            const ctx = document.getElementById('systemHealthChart')?.getContext('2d');
            if (ctx) {
                currentChartInstances.systemHealthChart = new Chart(ctx, {
                    type: 'line',
                    data: appData.dashboard.systemHealth,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white',
                                    font: { family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            },
                            y: {
                                ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // --- Projects View Logic ---
        function renderProjects(append = false) {
            const projectsListContainer = document.getElementById('projectsList');
            if (!projectsListContainer) return;

            if (!append) {
                projectsListContainer.innerHTML = ''; // Clear existing projects unless appending
                appData.projectLoadIndex = 0;
            }

            const searchTerm = document.getElementById('projectSearch')?.value.toLowerCase() || '';
            const filterStatus = document.getElementById('projectFilterStatus')?.value || 'all';

            // Apply search and filter to all projects first
            const filteredProjects = appData.projects.filter(project => {
                const matchesSearch = project.name.toLowerCase().includes(searchTerm) || project.id.toLowerCase().includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || project.status === filterStatus;
                return matchesSearch && matchesStatus;
            });

            // Determine which projects to render based on load index
            const projectsToRender = filteredProjects.slice(appData.projectLoadIndex, appData.projectLoadIndex + appData.projectsPerLoad);

            projectsToRender.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                // Adjust status display for Smart Toys context
                let displayStatus = project.status;
                if (project.status === 'live') displayStatus = 'Deployed';
                if (project.status === 'pending') displayStatus = 'Testing';
                if (project.status === 'draft') displayStatus = 'Development';
                if (project.status === 'error') displayStatus = 'Maintenance';


                projectCard.innerHTML = `
                    <h4 class="mb-2">${project.name}</h4>
                    <p><strong>ID:</strong> ${project.id}</p>
                    <p><strong>Region:</strong> ${project.region}</p>
                    <p><strong>Certification:</strong> ${project.royalty}</p>
                    <p><strong>Last Activity:</strong> ${project.lastActivity}</p>
                    <span class="project-status status-${project.status}">${displayStatus.toUpperCase()}</span>
                    <div class="project-actions">
                        <button onclick="window.openProjectInEditor('${project.id}')">
                            <i class="fas fa-edit mr-1"></i> Editor
                        </button>
                        <button class="secondary" onclick="window.showCustomModal('Action', 'Viewing live content for ${project.name} (ID: ${project.id})...')">
                            <i class="fas fa-globe mr-1"></i> Live
                        </button>
                        <button class="form-action-button text-xs px-3 py-2 mt-2" onclick="window.summarizeProject('${project.id}', this)">
                            ✨ Summarize Project
                        </button>
                        <p id="projectSummaryStatus-${project.id}" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </div>
                `;
                projectsListContainer.appendChild(projectCard);
            });

            appData.projectLoadIndex += projectsToRender.length;

            const loadMoreButton = document.getElementById('loadMoreProjects');
            if (loadMoreButton) {
                if (appData.projectLoadIndex >= filteredProjects.length) {
                    loadMoreButton.classList.add('view-hidden'); // Hide if no more projects
                } else {
                    loadMoreButton.classList.remove('view-hidden');
                }
            }
        }

        // Function to open a project in the integrated editor (NEW)
        window.openProjectInEditor = function(projectId) {
            const project = appData.projects.find(p => p.id === projectId);
            if (project) {
                document.getElementById('editorHtmlCssCode').value = project.htmlCode;
                document.getElementById('currentProjectEditName').textContent = `${project.name} Editor`;
                window.updateEditorPreview(); // Update the preview with the loaded code
                showView('editor-workspace'); // Switch to the editor view
            } else {
                window.showCustomModal('Project Not Found', `Could not find project with ID: ${projectId}`);
            }
        };

        // Function to summarize a project (NEW FEATURE)
        window.summarizeProject = async function(projectId, buttonElement) {
            const project = appData.projects.find(p => p.id === projectId);
            if (!project) {
                window.showCustomModal('Error', 'Project not found for summarization.');
                return;
            }

            const statusElementId = `projectSummaryStatus-${projectId}`;
            const statusElement = document.getElementById(statusElementId);

            const prompt = `Summarize the following Smart Toy project details concisely (max 80 words):
            Project Name: ${project.name}
            ID: ${project.id}
            Status: ${project.status}
            Region: ${project.region}
            Certification: ${project.royalty}
            Last Activity: ${project.lastActivity}

            Highlight the project's current state and main purpose within smart toy development.`;
            
            // Using a temporary invisible element for the target, as the output goes to a modal
            const tempOutputDiv = document.createElement('div');
            tempOutputDiv.id = `tempProjectSummaryOutput-${projectId}`;
            tempOutputDiv.style.display = 'none'; // Keep it hidden
            document.body.appendChild(tempOutputDiv);

            const summaryText = await window.callGeminiAPI(prompt, tempOutputDiv.id, statusElementId, buttonElement, 'Summarize Project');

            if (summaryText) {
                window.showProjectSummaryModal(`${project.name} Summary`, summaryText);
            } else {
                window.showCustomModal('Summarization Failed', 'Could not generate project summary. Please try again.');
            }
            document.body.removeChild(tempOutputDiv); // Clean up the temporary element
        };

        // Event listeners for project search/filter
        document.getElementById('projectSearch')?.addEventListener('input', () => renderProjects(false));
        document.getElementById('projectFilterStatus')?.addEventListener('change', () => renderProjects(false));
        document.getElementById('loadMoreProjects')?.addEventListener('click', () => renderProjects(true));


        // --- Gemini API Call Function ---
        window.callGeminiAPI = async function(prompt, targetElementId, statusElementId, buttonElement, type, parseJson = false) {
            const targetElement = document.getElementById(targetElementId);
            const statusElement = document.getElementById(statusElementId);
            
            if (!targetElement || !statusElement || !buttonElement) {
                console.error("Missing target, status element, or button element for Gemini API call.");
                return null; // Return null on error
            }

            statusElement.textContent = "Generating...";
            statusElement.classList.remove('hidden');
            if (targetElementId !== 'tempSimplifyOutput' && !targetElementId.startsWith('tempProjectSummaryOutput')) { // Don't hide the temp div used for simplification or project summary
                targetElement.classList.add('hidden'); // Hide output until ready
            }
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<span class="inline-block border-4 border-t-blue-500 border-gray-300 rounded-full w-5 h-5 animate-spin"></span>`; // Show spinner

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will automatically provide the API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    
                    if (parseJson) {
                        try {
                            const jsonResult = JSON.parse(text);
                            statusElement.textContent = "Generation complete!";
                            return jsonResult; // Return the parsed JSON object
                        } catch (jsonError) {
                            console.error("Failed to parse JSON from Gemini API:", jsonError);
                            statusElement.textContent = "Error: Could not parse AI response as JSON.";
                            return null;
                        }
                    } else {
                        // Check if the target is a textarea (has .value) or a general element (use .innerHTML)
                        if (targetElement.tagName === 'TEXTAREA' || targetElement.tagName === 'INPUT') {
                            targetElement.value = text;
                        } else {
                            targetElement.innerHTML = text; // For div or p tags
                        }
                        targetElement.classList.remove('hidden'); // Show output
                        statusElement.textContent = "Generation complete!";
                        return text; // Return the raw text
                    }
                } else {
                    statusElement.textContent = "Error: No content generated by AI.";
                    console.error("Gemini API returned an unexpected structure or no content:", result);
                    return null;
                }
            } catch (error) {
                statusElement.textContent = "Error: API call failed.";
                console.error("Error calling Gemini API:", error);
                return null;
            } finally {
                buttonElement.disabled = false;
                // Restore button text based on 'type' (from parameter)
                let originalButtonText = '';
                if (type === 'AI Generate') {
                    originalButtonText = 'AI Generate';
                } else if (type === 'Summarize Project') {
                    originalButtonText = 'Summarize Project';
                } else if (type === 'Simplify Agreement') {
                    originalButtonText = 'Simplify Agreement';
                } else if (type === 'Refine Code') {
                    originalButtonText = `Refine Code`;
                } else if (type === 'Explain Code') {
                    originalButtonText = `Explain Code`;
                } else if (type === 'Review Code') {
                    originalButtonText = `Review Code`;
                } else if (type === 'Generate Headline') {
                    originalButtonText = `Generate Headline`;
                } else if (type === 'Generate CTA') {
                    originalButtonText = `Generate CTA`;
                } else if (type === 'Generate Section Content') {
                    originalButtonText = `Generate Section Content`;
                } else if (type === 'Rephrase/Improve') {
                    originalButtonText = `Rephrase/Improve`;
                } else if (type === 'Explain DNS Type') {
                    originalButtonText = 'Explain DNS Type';
                } else if (type === 'Draft Email') {
                    originalButtonText = 'Generate Draft';
                }
                else {
                    originalButtonText = 'Action'; // Fallback
                }
                
                buttonElement.innerHTML = `✨ ${originalButtonText}`;
                setTimeout(() => statusElement.classList.add('hidden'), 3000); // Hide status after a few seconds
            }
        };


        // --- New Project Form Logic (with Gemini API Integration) ---
        document.getElementById('newProjectForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            const projectName = document.getElementById('projectName').value;
            const template = document.getElementById('template').value;
            const description = document.getElementById('description').value;
            const region = document.getElementById('region').value;
            const claim = document.getElementById('claim').value;

            // Simulate project creation
            const newProjectId = `TOY-${Math.floor(Math.random() * 10000)}`;
            let baseHtmlContent = '';
            const selectedTemplate = appData.templates.find(t => t.name === template);
            if (selectedTemplate && selectedTemplate.previewHtml) {
                // Remove outer div from previewHtml to integrate cleanly
                baseHtmlContent = selectedTemplate.previewHtml.replace(/<div[^>]*>|<\/div>/g, '');
            } else {
                baseHtmlContent = `<div style="background-color: #f5f5f7; color: #1d1d1f; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;"><h1>New Smart Toy Project: ${projectName}</h1><p>This is a new Smart Toy project created from template: ${template}.</p></div>`;
            }

            const newProject = {
                id: newProjectId,
                name: projectName,
                status: 'draft',
                region: region === 'global' ? 'Global Rollout' : (region === 'local' ? 'Regional Pilot' : 'Beta Testing Group'),
                royalty: claim === 'yes' ? 'VaultMint™ Gold' : 'N/A', // Updated royalty
                lastActivity: new Date().toLocaleDateString(),
                htmlCode: baseHtmlContent
            };
            appData.projects.unshift(newProject); // Add to the beginning of projects array
            appData.dashboard.totalProjects++; // Update total count

            window.showCustomModal('Project Created!', `Your project "${projectName}" (ID: ${newProjectId}) has been created. Status: Development.`);

            // Optionally clear form
            this.reset();
            // Go to projects view
            showView('projects');
        });

        // Event listener for Generate Description Button
        document.getElementById('generateDescriptionBtn')?.addEventListener('click', async (event) => {
            const projectName = document.getElementById('projectName').value.trim();
            const templateSelect = document.getElementById('template');
            const templateType = templateSelect.options[templateSelect.selectedIndex].textContent; // Get displayed text
            const region = document.getElementById('region').value;
            const button = event.currentTarget; // Get the button element

            if (!projectName) {
                window.showCustomModal('Input Required', 'Please enter a Project Name to generate a description.');
                return;
            }

            const prompt = `Generate a concise and engaging project description (max 100 words, 3-4 sentences) for a smart toy or educational technology project named '${projectName}' of type '${templateType}' intended for a '${region}' deployment. Focus on educational goals, interactive features, and child development impact.`;
            await window.callGeminiAPI(prompt, 'description', 'descriptionStatus', button, 'AI Generate');
        });

        // Event listener for Generate Project Idea Button
        document.getElementById('generateProjectIdeaBtn')?.addEventListener('click', async (event) => {
            const projectConcept = document.getElementById('projectConcept').value.trim();
            const button = event.currentTarget; // Get the button element
            const statusElement = document.getElementById('projectIdeaStatus');

            if (!projectConcept) {
                window.showCustomModal('Input Required', 'Please enter a high-level project concept to generate an idea.');
                return;
            }
            
            statusElement.textContent = "Generating project idea...";
            statusElement.classList.remove('hidden');

            const availableTemplates = appData.templates.map(t => t.name).join(', ');
            const prompt = `Generate a creative project name (max 5 words), a 3-4 sentence project description highlighting educational and innovative benefits for a smart toy project, and suggest one suitable template from the following list: ${availableTemplates}. The project is about: "${projectConcept}". Respond as a JSON object with keys: "projectName", "projectDescription", "suggestedTemplate".`;
            
            const aiIdea = await window.callGeminiAPI(prompt, 'hiddenIdeaOutput', 'projectIdeaStatus', button, 'AI Generate', true); // Use a hidden output element, parse JSON

            if (aiIdea) {
                window.showProjectIdeaModal(aiIdea.projectName, aiIdea.projectDescription, aiIdea.suggestedTemplate);
            } else {
                statusElement.textContent = "Failed to generate project idea. Please try again.";
            }
        });


        // --- Content Builder Form Logic (with Gemini API Integration) ---
        document.getElementById('scrollBuilderForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            window.showCustomModal('Content Compiled & Saved!', 'Your module has been compiled and saved to your workspace. It\'s now ready for VaultMint™ certification.');
            this.reset(); // Clear form
        });

        // Event listeners for Code Refinement Buttons
        document.getElementById('refineHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('htmlExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('htmlReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to refine.'); return; }
            const prompt = `Refine the following HTML code for better accessibility, semantic structure, and performance, specifically for smart toy learning modules, interactive content, or AR/holographic display. Provide the refined code only, no explanations. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlCode', 'htmlRefineStatus', button, 'Refine Code');
        });

        document.getElementById('refineCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('cssExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('cssReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to refine.'); return; }
            const prompt = `Optimize the following CSS code for efficiency, readability, and modern practices, focusing on visuals for smart toy interfaces, holographic projections, or AR overlays. Provide the refined code only, no explanations. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssCode', 'cssRefineStatus', button, 'Refine Code');
        });

        document.getElementById('refineJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('jsExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('jsReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to refine.'); return; }
            const prompt = `Refactor and optimize the following JavaScript code for readability, performance, and best practices, specifically for smart toy AI logic, adaptive learning algorithms, sensor integration, or child interaction. Provide the refined code only, no explanations. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsCode', 'jsRefineStatus', button, 'Refine Code');
        });

        // Event listeners for Code Explanation Buttons
        document.getElementById('explainHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget;
            document.getElementById('htmlReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to explain.'); return; }
            const prompt = `Explain the key components and their purpose in the following HTML code, particularly focusing on elements related to interactive smart toy content, such as learning modules or visual/audio feedback elements. Provide a high-level explanation. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlExplanationOutput', 'htmlRefineStatus', button, 'Explain Code');
        });

        document.getElementById('explainCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget;
            document.getElementById('cssReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to explain.'); return; }
            const prompt = `Explain the purpose of the main CSS rules and how they affect the layout and appearance of smart toy learning interfaces, interactive elements, or holographic/AR visuals. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssExplanationOutput', 'cssRefineStatus', button, 'Explain Code');
        });

        document.getElementById('explainJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget;
            document.getElementById('jsReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to explain.'); return; }
            const prompt = `Explain the main functions and logic of the following JavaScript code, focusing on its interaction with smart toy AI, adaptive learning, child behavior tracking, or interactive content delivery. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsExplanationOutput', 'jsRefineStatus', button, 'Explain Code');
        });

        // Event listeners for Code Review Buttons
        document.getElementById('reviewHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget;
            document.getElementById('htmlExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to review.'); return; }
            const prompt = `Provide a detailed code review for the following HTML, with a focus on best practices for smart toy learning modules, interactive content, or AR/holographic display. Point out potential issues, suggest improvements for child usability, accessibility (WCAG for kids), and performance. Use a clear, constructive tone. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlReviewOutput', 'htmlRefineStatus', button, 'Review Code');
        });

        document.getElementById('reviewCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget;
            document.getElementById('cssExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to review.'); return; }
            const prompt = `Provide a detailed code review for the following CSS, with a focus on styling for smart toy interfaces, holographic projections, or AR overlays. Suggest improvements for visual clarity, responsiveness (for various toy screen sizes/projections), and child-friendly aesthetics. Identify any redundant or conflicting styles. Use a clear, constructive tone. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssReviewOutput', 'cssRefineStatus', button, 'Review Code');
        });

        document.getElementById('reviewJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget;
            document.getElementById('jsExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to review.'); return; }
            const prompt = `Provide a detailed code review for the following JavaScript, with a focus on smart toy AI logic, adaptive learning algorithms, sensor integration, or child interaction. Suggest improvements for reliability, data privacy (COPPA/GDPR-K compliance), ethical AI considerations, performance, and adherence to best practices. Identify potential bugs or security vulnerabilities. Use a clear, constructive tone. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsReviewOutput', 'jsRefineStatus', button, 'Review Code');
        });


        // Event listener for Generate Content Ideas Button
        document.getElementById('generateContentIdeasBtn')?.addEventListener('click', async (event) => {
            const scrollTopic = document.getElementById('scrollTopic').value.trim();
            const button = event.currentTarget; // Get the button element
            if (!scrollTopic) {
                window.showCustomModal('Input Required', 'Please enter a topic to generate content ideas.');
                return;
            }
            const prompt = `Generate 5 creative and engaging content section ideas for a smart toy learning module about "${scrollTopic}". For each idea, provide a catchy title and a brief 1-2 sentence description, focusing on child engagement and learning outcomes. Format the output as a Markdown list.`;
            await window.callGeminiAPI(prompt, 'contentIdeasOutput', 'contentIdeasStatus', button, 'AI Generate');
        });


        // --- File Upload & URL Import Functions ---

        // Generic File Upload Handler
        function setupFileUpload(inputId, textareaId, statusId) {
            document.getElementById(inputId)?.addEventListener('change', function(event) {
                const file = event.target.files[0];
                const statusElement = document.getElementById(statusId);
                const textarea = document.getElementById(textareaId);

                if (!file) {
                    statusElement.textContent = 'No file selected.';
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    textarea.value = e.target.result;
                    statusElement.textContent = `File "${file.name}" loaded successfully.`;
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                };
                reader.onerror = () => {
                    statusElement.textContent = `Error reading file "${file.name}".`;
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                };
                reader.readAsText(file);
            });
        }

        // Generic URL Import Handler
        function setupUrlImport(buttonId, urlInputId, textareaId, statusId) {
            document.getElementById(buttonId)?.addEventListener('click', async function() {
                const url = document.getElementById(urlInputId).value.trim();
                const statusElement = document.getElementById(statusId);
                const textarea = document.getElementById(textareaId);

                if (!url) {
                    window.showCustomModal('Input Required', 'Please enter a URL to import code from.');
                    return;
                }

                statusElement.textContent = 'Importing from URL...';
                statusElement.classList.remove('hidden');
                // Temporarily disable elements
                document.getElementById(buttonId).disabled = true;
                document.getElementById(urlInputId).disabled = true;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const text = await response.text();
                    textarea.value = text;
                    statusElement.textContent = 'Code imported successfully from URL.';
                } catch (error) {
                    statusElement.textContent = `Error importing code: ${error.message}`;
                    console.error('URL Import Error:', error);
                    window.showCustomModal('Import Error', `Failed to import code from URL: ${error.message}`, true);
                } finally {
                    document.getElementById(buttonId).disabled = false;
                    document.getElementById(urlInputId).disabled = false;
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                }
            });
        }


        // --- Templates View Logic ---
        function renderTemplates() {
            const templatesGrid = document.getElementById('templatesGrid');
            if (!templatesGrid) return;
            templatesGrid.innerHTML = ''; // Clear existing templates

            appData.templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'panel bg-gray-900 border border-gray-700'; // Apply consistent panel styling
                
                // Construct inner HTML
                templateCard.innerHTML = `
                    <h4 class="mb-2"><i class="${template.icon} mr-2"></i> ${template.name}</h4>
                    <p class="text-gray-400 text-sm">${template.description}</p>
                `;
                // Create button separately and attach event listener
                const useTemplateButton = document.createElement('button');
                useTemplateButton.className = 'form-action-button mt-4';
                useTemplateButton.textContent = 'Use This Template';
                useTemplateButton.addEventListener('click', () => {
                    window.showTemplatePreviewModal(template); // Show template preview
                });
                templateCard.appendChild(useTemplateButton); // Append button to card

                templatesGrid.appendChild(templateCard);
            });
            // Ensure templates dropdowns are also populated when this view renders
            populateTemplateSelects();
        }

        // Helper function to populate template selects (called during initial load and template view render)
        function populateTemplateSelects() {
            const newProjectTemplateSelect = document.querySelector('#new-project-view #template');
            if(newProjectTemplateSelect) {
                newProjectTemplateSelect.innerHTML = appData.templates.map(t => `<option value="${t.name}">${t.name}</option>`).join(''); // Using name as value for simplicity
                newProjectTemplateSelect.insertAdjacentHTML('afterbegin', '<option value="">Select a template...</option>');
                newProjectTemplateSelect.value = ""; // Default empty
            }

            const scrollBuilderTemplateSelect = document.querySelector('#scroll-builder-view #sbScrollType');
            if(scrollBuilderTemplateSelect) {
                scrollBuilderTemplateSelect.innerHTML = `
                    <option value="">Select a module type...</option>
                    <option value="phonics-module">Phonics Module</option>
                    <option value="emotional-story">Emotional Storytelling Narrative</option>
                    <option value="gamified-math">Gamified Math Adventure</option>
                    <option value="parent-dashboard-layout">AI Parental Dashboard Layout</option>
                   `;
            }
        }

        // --- Template Preview Modal Logic ---
        window.showTemplatePreviewModal = function(template) {
            const modal = document.getElementById('templatePreviewModal');
            const previewTitle = document.getElementById('templatePreviewTitle');
            const previewFrame = document.getElementById('templatePreviewFrame');
            const previewDescription = document.getElementById('templatePreviewDescription');
            const useTemplateNewProjectBtn = document.getElementById('useTemplateNewProjectBtn');
            const useTemplateScrollBuilderBtn = document.getElementById('useTemplateScrollBuilderBtn');

            if (!modal || !previewTitle || !previewFrame || !previewDescription || !useTemplateNewProjectBtn || !useTemplateScrollBuilderBtn) return;

            previewTitle.textContent = template.name;
            previewDescription.textContent = template.description;
            
            // Set iframe srcdoc with the template's preview HTML
            previewFrame.srcdoc = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Preview</title>
                    <style>
                        /* Common preview styles, ensure colors match the current dashboard theme (light/dark) */
                        body { 
                            font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; text-align: center; 
                            background-color: ${document.body.classList.contains('light-mode') ? '#f8f8f8' : '#1a1a1c'}; 
                            color: ${document.body.classList.contains('light-mode') ? '#1d1d1f' : '#f5f5f7'};
                        }
                        h1 { 
                            font-size: 1.8rem; font-weight: 800; margin-bottom: 1rem;
                            color: #0071e3; /* Primary Blue */
                        }
                        h1 span {
                            color: #facc15; /* Accent Yellow */
                        }
                        h2 { 
                            font-size: 1.2rem; color: ${document.body.classList.contains('light-mode') ? '#424245' : '#a0a0a5'}; margin-bottom: 1.5rem; 
                        }
                        p { 
                            font-size: 0.95rem; line-height: 1.5; 
                            color: ${document.body.classList.contains('light-mode') ? '#6e6e73' : '#b0b0b0'}; 
                        }
                        button { 
                            background-color: #facc15; 
                            color: black; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;
                        }
                        img {
                            width: 80%;
                            max-width: 400px;
                            margin: 1.5rem auto;
                            display: block;
                        }
                    </style>
                </head>
                <body>
                    ${template.previewHtml}
                </body>
                </html>
            `;
            
            // Set up action buttons to select template in forms
            useTemplateNewProjectBtn.onclick = () => {
                window.hideTemplatePreviewModal();
                showView('new-project');
                const selectElement = document.querySelector('#new-project-view #template');
                if (selectElement) { selectElement.value = template.name; } // Set value to template name
            };

            useTemplateScrollBuilderBtn.onclick = () => {
                window.hideTemplatePreviewModal();
                window.showCustomModal('Feature Not Fully Implemented', 'This feature is currently in development. Please select the template in the Content Builder manually.', true); // Informative message
                showView('scroll-builder');
            };


            modal.classList.add('active'); // Show modal with animation
        };

        window.hideTemplatePreviewModal = function() {
            document.getElementById('templatePreviewModal')?.classList.remove('active'); // Hide modal with animation
        };

        // --- Simplify Agreement Modal Logic ---
        window.showSimplifyAgreementModal = function(title, simplifiedText) {
            const modal = document.getElementById('simplifyAgreementModal');
            const modalTitle = document.getElementById('simplifyAgreementTitle');
            const modalText = document.getElementById('simplifiedAgreementText');

            if (modal && modalTitle && modalText) {
                modalTitle.textContent = title;
                modalText.innerHTML = simplifiedText; // Use innerHTML to allow for formatting
                modal.classList.add('active'); // Show modal with animation
            }
        };

        window.hideSimplifyAgreementModal = function() {
            document.getElementById('simplifyAgreementModal')?.classList.remove('active'); // Hide modal with animation
        };

        // --- Project Idea Modal Logic ---
        window.showProjectIdeaModal = function(projectName, projectDescription, suggestedTemplate) {
            const modal = document.getElementById('projectIdeaModal');
            const ideaProjectName = document.getElementById('ideaProjectName');
            const ideaProjectDescription = document.getElementById('ideaProjectDescription');
            const ideaSuggestedTemplate = document.getElementById('ideaSuggestedTemplate');
            const applyButton = document.getElementById('applyProjectIdeaBtn');

            if (modal && ideaProjectName && ideaProjectDescription && ideaSuggestedTemplate && applyButton) {
                ideaProjectName.textContent = projectName;
                ideaProjectDescription.textContent = projectDescription;
                ideaSuggestedTemplate.textContent = suggestedTemplate;

                applyButton.onclick = () => {
                    document.getElementById('projectName').value = projectName;
                    document.getElementById('description').value = projectDescription;
                    const templateSelect = document.getElementById('template');
                    if (templateSelect) {
                        const optionExists = Array.from(templateSelect.options).some(option => option.value === suggestedTemplate);
                        if (optionExists) {
                            templateSelect.value = suggestedTemplate;
                        } else {
                            // If suggested template doesn't exist, select the first available or default
                            templateSelect.value = templateSelect.options[1] ? templateSelect.options[1].value : ""; 
                            window.showCustomModal('Template Not Found', `"${suggestedTemplate}" template not found. Selected a default.`, true);
                        }
                    }
                    window.hideProjectIdeaModal();
                };

                modal.classList.add('active');
            }
        };

        window.hideProjectIdeaModal = function() {
            document.getElementById('projectIdeaModal')?.classList.remove('active');
        };

        // --- Project Summary Modal (NEW) ---
        window.showProjectSummaryModal = function(title, summaryText) {
            const modal = document.getElementById('projectSummaryModal');
            const modalTitle = document.getElementById('projectSummaryTitle');
            const modalText = document.getElementById('projectSummaryText');

            if (modal && modalTitle && modalText) {
                modalTitle.textContent = title;
                modalText.innerHTML = summaryText; // Use innerHTML to allow for formatting
                modal.classList.add('active');
            }
        };

        window.hideProjectSummaryModal = function() {
            document.getElementById('projectSummaryModal')?.classList.remove('active');
        };

        // --- Email Draft Modal (NEW) ---
        let currentEmailForDraft = ''; // Store the email being drafted for

        window.openEmailDraftModal = function(emailAddress) {
            currentEmailForDraft = emailAddress;
            const modal = document.getElementById('emailDraftModal');
            const modalTitle = document.getElementById('emailDraftTitle');
            const emailDraftTo = document.getElementById('emailDraftTo');
            const emailPurposeInput = document.getElementById('emailPurposeInput');
            const generatedEmailDraftOutput = document.getElementById('generatedEmailDraftOutput');
            const emailDraftStatus = document.getElementById('emailDraftStatus');

            if (modal && modalTitle && emailDraftTo && emailPurposeInput && generatedEmailDraftOutput && emailDraftStatus) {
                modalTitle.textContent = `Draft Email for ${emailAddress}`;
                emailDraftTo.textContent = emailAddress;
                emailPurposeInput.value = ''; // Clear previous input
                generatedEmailDraftOutput.value = ''; // Clear previous draft
                emailDraftStatus.classList.add('hidden'); // Hide status
                modal.classList.add('active');
            }
        };

        window.hideEmailDraftModal = function() {
            document.getElementById('emailDraftModal')?.classList.remove('active');
            currentEmailForDraft = ''; // Clear stored email
        };


        // --- Licenses View Logic ---
        function renderLicenses() {
            const licensesList = document.getElementById('licensesList');
            if (!licensesList) return;
            licensesList.innerHTML = ''; // Clear existing licenses

            appData.licenses.forEach(license => {
                const statusClass = license.verified ? 'status-live' : 'status-pending';
                const buttonText = license.verified ? 'Open in Workspace' : 'Certify Now';
                const buttonAction = license.verified ? 'window.showCustomModal("Action", `Opening workspace for ${license.name} (simulated)...`)' : 'window.showCustomModal("Certification Initiated", `Initiating VaultMint™ certification for ${license.name}. Please check back later. (simulated)`)';

                const licenseCard = document.createElement('div');
                licenseCard.className = 'panel bg-gray-900 border border-gray-700';
                licenseCard.innerHTML = `
                    <h4 class="mb-2">${license.name}</h4>
                    <p><strong>License ID:</strong> <span class="text-gray-400">${license.id}</span></p>
                    <p><strong>Region:</strong> <span class="text-gray-400">${license.region}</span></p>
                    <p><strong>Certification:</strong> <span class="text-gray-400">${license.royalty}</span></p>
                    <p><strong>Activation Date:</strong> <span class="text-gray-400">${license.activationDate}</span></p>
                    <p><strong>VaultMint™ Status:</strong> <span class="text-gray-400">${license.claimStatus}</span></p>
                    <p class="project-status ${statusClass} mt-3">
                        <i class="fas ${license.verified ? 'fa-check-circle' : 'fa-hourglass-half'} mr-1"></i>
                        ${license.verified ? 'Certified & Active' : 'Awaiting VaultMint™ Certification'}
                    </p>
                    <button class="form-action-button mt-4" onclick='${buttonAction}'>
                        ${buttonText}
                    </button>
                `;
                licensesList.appendChild(licenseCard);
            });
        }

        function renderRoyaltyAgreements() {
            const agreementsList = document.getElementById('royaltyAgreementsList');
            if (!agreementsList) return;
            agreementsList.innerHTML = '';

            appData.royaltyAgreements.forEach(agreement => {
                const statusClass = agreement.status === 'Signed' ? 'status-live' : 'status-pending';
                const buttonText = agreement.status === 'Signed' ? 'View Agreement' : 'Sign via SecureSign™';
                
                const signButton = document.createElement('button');
                signButton.className = 'form-action-button mt-4';
                signButton.innerHTML = `<i class="fas ${agreement.status === 'Signed' ? 'fa-eye' : 'fa-signature'} mr-2"></i> ${buttonText}`;
                signButton.addEventListener('click', () => { // Add event listener here
                    window.showCustomModal("SecureSign™", `Redirecting to SecureSign™ for signature of "${agreement.name}". Please confirm in the pop-up. (simulated)`, true); // Now `agreement` is scoped
                    // In a real app, this would redirect to SecureSign with agreement ID
                    // window.open('securesign_portal.html?agreementId=' + agreement.id, '_blank');
                });

                const simplifyButton = document.createElement('button');
                simplifyButton.className = 'form-action-button secondary ml-2 mt-4';
                simplifyButton.id = `simplifyAgreementBtn-${agreement.id}`; // Unique ID for each button
                simplifyButton.innerHTML = `✨ Simplify Agreement`;
                const simplifyStatusId = `simplifyAgreementStatus-${agreement.id}`;
                const simplifyStatusElement = document.createElement('p');
                simplifyStatusElement.id = simplifyStatusId;
                simplifyStatusElement.className = 'text-xs text-gray-400 mt-1 hidden';


                simplifyButton.addEventListener('click', async (event) => {
                    const button = event.currentTarget;
                    if (!agreement.description.trim()) {
                        window.showCustomModal('No Text', 'There is no description to simplify for this agreement.', true);
                        return;
                    }
                    const prompt = `Simplify the following legal agreement text into plain, easy-to-understand language. Keep it concise but capture all key points. Do not include any introductory or concluding remarks outside the simplified text itself. \n\n${agreement.description}`;
                    // Use a temporary div to get the output from Gemini API, then pass to modal
                    const tempOutputDiv = document.createElement('div');
                    tempOutputDiv.id = 'tempSimplifyOutput'; // Give it an ID so callGeminiAPI can target it
                    document.body.appendChild(tempOutputDiv); // Temporarily add to DOM for targeting

                    await window.callGeminiAPI(prompt, tempOutputDiv.id, simplifyStatusId, button, 'Simplify Agreement');
                    
                    if (tempOutputDiv.textContent) {
                        window.showSimplifyAgreementModal(`${agreement.name} (Simplified)`, tempOutputDiv.textContent);
                    }
                    document.body.removeChild(tempOutputDiv); // Clean up temp div
                });

                const agreementCard = document.createElement('div');
                agreementCard.className = 'panel bg-gray-900 border border-gray-700';
                agreementCard.innerHTML = `
                    <h4 class="mb-2">${agreement.name}</h4>
                    <p class="text-gray-400 text-sm mb-2">${agreement.description}</p>
                    <p><strong>Status:</strong> <span class="project-status ${statusClass}">${agreement.status.toUpperCase()}</span></p>
                `;
                agreementCard.appendChild(signButton); // Append the sign button
                agreementCard.appendChild(simplifyButton); // Append the simplify button
                agreementCard.appendChild(simplifyStatusElement); // Append the status element

                agreementsList.appendChild(agreementCard);
            });
        }


        // --- Analytics View Logic ---
        function renderAnalyticsCharts() {
            // Deployment Trends
            const dtCtx = document.getElementById('deploymentTrendsChart')?.getContext('2d');
            if (dtCtx) {
                currentChartInstances.deploymentTrendsChart = new Chart(dtCtx, {
                    type: 'bar',
                    data: appData.analytics.deploymentTrends,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                        scales: {
                            x: { ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } },
                            y: { beginAtZero: true, ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }

            // Royalty Distribution
            const rdCtx = document.getElementById('royaltyDistributionChart')?.getContext('2d');
            if (rdCtx) {
                currentChartInstances.royaltyDistributionChart = new Chart(rdCtx, {
                    type: 'doughnut',
                    data: appData.analytics.royaltyDistribution,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                    }
                });
            }

            // User Activity
            const uaCtx = document.getElementById('userActivityChart')?.getContext('2d');
            if (uaCtx) {
                currentChartInstances.userActivityChart = new Chart(uaCtx, {
                    type: 'line',
                    data: appData.analytics.userActivity,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                        scales: {
                            x: { ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } },
                            y: { beginAtZero: true, ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }
        }

        // --- API Keys View Logic ---
        function renderApiKeysTable() {
            const apiKeysTableBody = document.getElementById('apiKeysTableBody');
            if (!apiKeysTableBody) return;
            apiKeysTableBody.innerHTML = '';

            appData.apiKeys.forEach(keyData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold text-gray-200">${keyData.service} <br> ${keyData.context ? `<span class="text-xs text-gray-400">(${keyData.context})</span>` : ''}</td>
                    <td class="api-key-value">${keyData.key}</td>
                    <td class="text-gray-400 text-sm">${keyData.locations.join(', ')}</td>
                `;
                apiKeysTableBody.appendChild(row);
            });
        }

        // --- Settings View Logic ---
        function loadSettings() {
            document.getElementById('displayName').value = appData.user.displayName;
            document.getElementById('email').value = appData.user.email;
            document.getElementById('defaultRegion').value = appData.user.defaultRegion;
            document.getElementById('autoClaimSetting').value = appData.user.autoClaim;

            // Render DNS records and email accounts
            renderDnsRecords();
            renderEmailAccounts();
            renderDomains();
            renderSettingsCompanySelection(); // Render company selection for settings
        }

        // Settings Tab Navigation Logic
        function showSettingsTab(tabId) {
            // Hide all sub-views
            document.querySelectorAll('.settings-sub-view').forEach(view => {
                view.classList.add('hidden');
            });
            // Show the selected sub-view
            document.getElementById(`settings-${tabId}`).classList.remove('hidden');

            // Update active button state
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                if (btn.getAttribute('data-settings-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Re-render domain/email/dns data if switching to that tab
            if (tabId === 'domains') {
                renderDnsRecords();
                renderEmailAccounts();
                renderDomains();
                renderSettingsCompanySelection(); // Ensure selection is rendered on tab switch
            }
        }
        window.showSettingsTab = showSettingsTab; // Make global for direct calls from HTML

        // Render DNS Records
        function renderDnsRecords() {
            const dnsTableBody = document.getElementById('dnsRecordsTableBody');
            if (!dnsTableBody) return;
            dnsTableBody.innerHTML = '';
            appData.dnsRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold">${record.type}</td>
                    <td>${record.name}</td>
                    <td>${record.value}</td>
                    <td>${record.ttl}</td>
                    <td class="text-right">
                        <button class="text-blue-500 hover:text-blue-700 text-sm mr-2" onclick="window.showCustomModal('Edit DNS', 'Edit functionality for ${record.name} coming soon!')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" onclick="window.showCustomModal('Delete DNS', 'Delete functionality for ${record.name} coming soon!')">Delete</button>
                    </td>
                `;
                dnsTableBody.appendChild(row);
            });
        }

        // Render Domains
        function renderDomains() {
            const domainList = document.getElementById('domainList');
            const addonDomainTargetSelect = document.getElementById('addonDomainTarget');
            if (!domainList || !addonDomainTargetSelect) return;
            
            domainList.innerHTML = ''; // Clear existing
            addonDomainTargetSelect.innerHTML = '<option value="">Select Primary Domain</option>';

            appData.domains.forEach(domain => {
                const listItem = document.createElement('li');
                const statusIcon = domain.type.includes('Pending') ? 'fas fa-hourglass-half text-yellow-500' : 'fas fa-check-circle text-green-500';
                listItem.innerHTML = `<i class="${statusIcon} mr-2"></i> ${domain.name} (${domain.type})`;
                domainList.appendChild(listItem);

                // Populate add-on domain select only with primary/active domains
                if (domain.type.includes('Primary') || domain.type.includes('Subdomain')) {
                    const option = document.createElement('option');
                    option.value = domain.name;
                    option.textContent = domain.name;
                    addonDomainTargetSelect.appendChild(option);
                }
            });
        }


        // Render Email Accounts
        function renderEmailAccounts() {
            const emailAccountsTableBody = document.getElementById('emailAccountsTableBody');
            if (!emailAccountsTableBody) return;
            emailAccountsTableBody.innerHTML = '';
            appData.emailAccounts.forEach(account => {
                const row = document.createElement('tr');
                const statusClass = account.status === 'Active' ? 'text-green-500' : 'text-yellow-500';
                row.innerHTML = `
                    <td class="font-semibold">${account.email}</td>
                    <td><span class="${statusClass}">${account.status}</span></td>
                    <td class="text-right">
                        <button class="text-blue-500 hover:text-blue-700 text-sm mr-2" onclick="window.showCustomModal('Edit Email', 'Edit email ${account.email} functionality coming soon!')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" onclick="window.showCustomModal('Delete Email', 'Delete email ${account.email} functionality coming soon!')">Delete</button>
                        <button class="form-action-button text-xs px-3 py-2 mt-2 ml-2" onclick="window.openEmailDraftModal('${account.email}')">
                            ✨ Draft Email
                        </button>
                    </td>
                `;
                emailAccountsTableBody.appendChild(row);
            });
        }

        // Render company selection cards for settings panel
        function renderSettingsCompanySelection() {
            const settingsCompanySelectionGrid = document.getElementById('settingsCompanySelectionGrid');
            if (settingsCompanySelectionGrid) {
                settingsCompanySelectionGrid.innerHTML = ''; // Clear previous selections
                // Filter companyData to only show companies in relevant sectors for this dashboard (education-youth, maybe mining for cross-sector ops view)
                const relevantCompanies = Object.entries(companyData).filter(([key, company]) => 
                    company.sector_key === "education-youth" || company.sector_key === "mining"
                );

                relevantCompanies.forEach(([key, company]) => {
                    const card = document.createElement('div');
                    card.className = 'company-select-card p-4 rounded-lg text-center shadow-md cursor-pointer bg-gray-700 hover:bg-gray-600 border border-gray-600'; // Added styling classes
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-white">${company.name}</h3>
                        <p class="text-gray-400 text-xs">Sector: ${sectorList[company.sector_key].name}</p>
                    `;
                    card.onclick = () => window.renderSettingsCompanyDetails(key);
                    settingsCompanySelectionGrid.appendChild(card);
                });
            }
        }

        // Render detailed company information in settings
        window.renderSettingsCompanyDetails = function(companyKey) {
            const company = companyData[companyKey];
            const detailsOutput = document.getElementById('settingsCompanyDetailsOutput');
            if (!company || !detailsOutput) return;

            detailsOutput.innerHTML = `
                <h4 class="text-xl font-bold mb-4 text-white">${company.name} Infrastructure Details</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                    ${Object.entries(company.details).map(([key, value]) => `
                        <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                            <strong class="text-yellow-400">${key}:</strong> ${value}
                        </div>
                    `).join('')}
                </div>
                <button class="form-action-button mt-4 bg-red-600 hover:bg-red-700" onclick="showCustomModal('Simulation', 'Advanced company management tools coming soon!', true)">
                    <i class="fas fa-cogs mr-1"></i> Manage Company Infrastructure
                </button>
            `;
            detailsOutput.classList.remove('hidden');
        };

        // --- Ecosystem Map Functions ---
        // Function to render the Ecosystem Map
        function renderEcosystemMap() {
            const sectorContainer = document.getElementById('sectorContainer').querySelector('.space-y-3');
            if (!sectorContainer) return;
            sectorContainer.innerHTML = ''; // Clear previous content

            // Sort sectors alphabetically by name for consistent display
            const sortedSectorKeys = Object.keys(allSectorsData).sort((a, b) => {
                return allSectorsData[a].name.localeCompare(allSectorsData[b].name);
            });

            sortedSectorKeys.forEach(sectorKey => {
                const sector = allSectorsData[sectorKey];
                const sectorDiv = document.createElement('div');
                sectorDiv.className = 'border border-gray-700 rounded-lg p-4 mb-4 bg-gray-800';
                sectorDiv.innerHTML = `
                    <button class="toggle-section-btn flex justify-between items-center w-full text-left p-2 -mx-2 -my-2 rounded-md hover:bg-gray-700 transition-colors duration-200" onclick="window.toggleSection('sector-${sectorKey}')">
                        <span class="text-blue-400 text-xl font-bold">${sector.name} <span class="text-gray-400 text-sm">(${sector.baseUrl})</span></span>
                        <span><i class="fas fa-chevron-down text-gray-400"></i></span>
                    </button>
                    <div id="sector-${sectorKey}" class="repo-content-section hidden mt-4">
                        <h4 class="text-lg font-semibold text-yellow-400 mb-2">Repository & Base URL:</h4>
                        <div class="copy-square">
                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">${sector.repoName}/</pre>
                        </div>
                        <div class="copy-square mt-2">
                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">${sector.baseUrl}/index</pre>
                        </div>
                        
                        <h4 class="text-lg font-semibold text-yellow-400 mb-2 mt-4">Brands & Subnodes:</h4>
                        <div class="space-y-2">
                            ${sector.brands.map(brand => `
                                <div class="border border-gray-700 rounded-md p-3 bg-gray-700">
                                    <button class="toggle-section-btn !bg-transparent !shadow-none !text-left !px-0 !py-0 !mb-0 flex justify-between items-center w-full hover:bg-gray-600 transition-colors duration-200" onclick="window.toggleSection('brand-${sectorKey}-${brand.name.replace(/ /g, '-')}')">
                                        <span class="text-white font-medium">${brand.name}</span> <span><i class="fas fa-chevron-down"></i></span>
                                    </button>
                                    <div id="brand-${sectorKey}-${brand.name.replace(/ /g, '-')}" class="repo-content-section !border-none !bg-transparent !p-0 hidden mt-2">
                                        <div class="copy-square">
                                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                            <pre class="conversation-code-block">${sector.baseUrl}/brands/${encodeURIComponent(brand.name.toLowerCase().replace(/ /g, '-'))}/index</pre>
                                        </div>
                                        ${brand.subnodes.map(subnode => `
                                            <div class="copy-square ml-4 mt-2">
                                                <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                                <pre class="conversation-code-block">${sector.baseUrl}/brands/${encodeURIComponent(brand.name.toLowerCase().replace(/ /g, '-'))}/${encodeURIComponent(subnode.toLowerCase().replace(/ /g, '-'))}/index</pre>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <h4 class="text-lg font-semibold text-yellow-400 mb-2 mt-4">Global Footer Pages (Example Paths):</h4>
                        <div class="space-y-2">
                            <div class="copy-square">
                                <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                <pre class="conversation-code-block">
${[
    '/privacy', '/terms', '/contact', '/copyright', '/developers',
    '/vaultmesh', '/fruitful', '/faa.zone', '/about', '/accessibility'
].map(p => `${sector.baseUrl}${p}`).join('\n')}
                                </pre>
                            </div>
                            <a href="#" class="footer-pages-link" onclick="window.showCustomModal('Global Footer', 'The global footer files are deployed from a dedicated repository and automatically linked.', true)">Learn more about Global Footer deployment</a>
                        </div>
                    </div>
                `;
                sectorContainer.appendChild(sectorDiv);
            });
        }

        // Utility function to toggle section visibility (for ecosystem map)
        window.toggleSection = function(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('hidden');
                const icon = element.previousElementSibling.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            }
        };

        // Utility function to copy text to clipboard (for ecosystem map and emails)
        window.copyToClipboard = function(buttonElement) {
            const preElement = buttonElement.nextElementSibling; // Get the <pre> tag next to the button
            if (preElement && preElement.tagName === 'PRE') {
                const textToCopy = preElement.textContent.trim();
                try {
                    // Use execCommand for broader compatibility within iframes
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    window.showCustomModal('Copied!', 'Text copied to clipboard.', true);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    window.showCustomModal('Copy Failed', 'Failed to copy text. Please try manually.', true);
                }
            }
        };


        // --- Login and Signup Form Logic ---
        document.getElementById('loginForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (email === "smarttoys.dev@example.com" && password === "password123") {
                window.showCustomModal('Login Successful!', 'Welcome back, Smart Toys Innovator!', true);
                // Simulate successful login - redirect to dashboard after modal
                setTimeout(() => {
                    showView('dashboard');
                }, 1500);
            } else {
                window.showCustomModal('Login Failed', 'Invalid email or password. Please try again.', true);
            }
        });

        document.getElementById('signupForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (password !== confirmPassword) {
                window.showCustomModal('Signup Failed', 'Passwords do not match. Please try again.', true);
                return;
            }
            if (password.length < 6) { // Basic password length validation
                window.showCustomModal('Signup Failed', 'Password must be at least 6 characters long.', true);
                return;
            }

            // Simulate successful registration
            window.showCustomModal('Registration Successful!', `Welcome, ${name}! Your account has been created. Please sign in.`, true);
            
            // Optionally clear form
            this.reset();
            // Redirect to login page after a short delay
            setTimeout(() => {
                showView('login');
            }, 1500);
        });


        // --- Initial App Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // First, ensure all CSS custom properties are computed and stored in appData.colors
            // This needs to happen BEFORE any charts or elements that rely on these colors are rendered.
            const rootStyles = getComputedStyle(document.documentElement);
            appData.colors.primary = rootStyles.getPropertyValue('--primary-color').trim();
            appData.colors.secondary = rootStyles.getPropertyValue('--secondary-color').trim();
            appData.colors.textDark = rootStyles.getPropertyValue('--text-color-dark').trim();
            appData.colors.borderColorDark = rootStyles.getPropertyValue('--border-color-dark').trim();
            appData.colors.accentGold = rootStyles.getPropertyValue('--accent-gold').trim();

            // Set up sidebar navigation clicks
            document.querySelectorAll('.sidebar .nav-list a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default link behavior
                    const viewId = e.currentTarget.getAttribute('data-view');
                    if (viewId) {
                        showView(viewId);
                    }
                });
            });

            // Set up settings tab clicks
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabId = e.currentTarget.getAttribute('data-settings-tab');
                    showSettingsTab(tabId);
                });
            });


            // Set the initial view based on hash or default to dashboard
            const initialView = window.location.hash.substring(1) || 'dashboard';
            showView(initialView);

            // Populate template select dropdowns initially
            populateTemplateSelects();
            
            // Setup file upload and URL import listeners
            setupFileUpload('uploadHtml', 'htmlCode', 'htmlRefineStatus');
            setupUrlImport('importHtmlUrlBtn', 'importHtmlUrl', 'htmlCode', 'htmlRefineStatus');
            setupFileUpload('uploadCss', 'cssCode', 'cssRefineStatus');
            setupUrlImport('importCssUrlBtn', 'importCssUrl', 'cssCode', 'cssRefineStatus');
            setupFileUpload('uploadJs', 'jsCode', 'jsRefineStatus');
            setupUrlImport('importJsUrlBtn', 'importJsUrl', 'jsCode', 'jsRefineStatus');

            // Setup DNS Explain button listener
            document.getElementById('explainDnsBtn')?.addEventListener('click', async (event) => {
                const dnsType = document.getElementById('dnsRecordTypeInput').value.trim();
                const button = event.currentTarget;
                if (!dnsType) {
                    window.showCustomModal('Input Required', 'Please enter a DNS record type (e.g., A, CNAME, MX) to explain.');
                    return;
                }
                const prompt = `Explain what a "${dnsType}" DNS record is, its primary purpose, and a typical use case. Keep the explanation concise and easy to understand for a non-expert.`;
                await window.callGeminiAPI(prompt, 'dnsExplanationOutput', 'dnsExplainStatus', button, 'Explain DNS Type');
            });

            // Event listener for Generate Email Draft Button (NEW)
            document.getElementById('generateEmailDraftBtn')?.addEventListener('click', async (event) => {
                const emailPurpose = document.getElementById('emailPurposeInput').value.trim();
                const button = event.currentTarget;
                if (!emailPurpose) {
                    window.showCustomModal('Input Required', 'Please enter a purpose for the email.');
                    return;
                }
                const prompt = `Draft a professional email (max 200 words) for the purpose of "${emailPurpose}" from the email address "${currentEmailForDraft}". Focus on a clear and polite tone. Provide only the email body.`;
                await window.callGeminiAPI(prompt, 'generatedEmailDraftOutput', 'emailDraftStatus', button, 'Draft Email');
            });


            // Event Listeners for AI buttons within the integrated editor (re-mapped IDs)
            document.getElementById('editorRefineCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden');
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to refine.'); return; }
                const prompt = `Refine the following HTML/CSS code for better accessibility, semantic structure, and performance, specifically for smart toy learning modules, interactive content, or AR/holographic display. Provide the refined code only, no explanations. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssCode', 'editorHtmlCssStatus', button, 'Refine Code');
            });

            document.getElementById('editorExplainCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to explain.'); return; }
                const prompt = `Explain the key components and their purpose in the following HTML code, particularly focusing on elements related to interactive smart toy content, such as learning modules or visual/audio feedback elements. Provide a high-level explanation. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssExplanationOutput', 'editorHtmlCssStatus', button, 'Explain Code');
            });

            document.getElementById('editorReviewCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to review.'); return; }
                const prompt = `Provide a detailed code review for the following HTML/CSS, with a focus on best practices for smart toy learning modules, interactive content, or AR/holographic display. Point out potential issues, suggest improvements for child usability, accessibility (WCAG for kids), and performance. Use a clear, constructive tone. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssReviewOutput', 'editorHtmlCssStatus', button, 'Review Code');
            });

            document.getElementById('editorGenerateHeadlineBtn')?.addEventListener('click', async (event) => {
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');    
                if (!currentContent.trim()) {
                    window.showCustomModal('Input Required', 'Please provide some content in the editor to generate a headline.');
                    return;
                }
                const prompt = `Generate 3 concise and catchy headlines for a smart toy learning module based on the following HTML content. Focus on appealing to parents and children, highlighting educational and fun aspects. Provide only the headlines as a markdown list. \n\n${currentContent}`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate Headline');
            });

            document.getElementById('editorGenerateCTABtn')?.addEventListener('click', async (event) => {
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');    
                if (!currentContent.trim()) {
                    window.showCustomModal('Input Required', 'Please provide some content in the editor to generate a Call to Action.');
                    return;
                }
                const prompt = `Generate 3 compelling and concise Calls-to-Action (CTAs) for a smart toy learning module based on the following HTML content. Make them action-oriented and encourage engagement (e.g., "Start Learning Adventure", "Unlock New Skills"). Provide only the CTAs as a markdown list. \n\n${currentContent}`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate CTA');
            });

            document.getElementById('editorGenerateSectionContentBtn')?.addEventListener('click', async (event) => {
                const sectionTopic = document.getElementById('editorSectionTopicInput').value.trim();
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');    
                if (!sectionTopic) {
                    window.showCustomModal('Input Required', 'Please enter a topic for the section content.');
                    return;
                }
                const prompt = `Generate a 2-3 paragraph section about "${sectionTopic}" for a smart toy learning module. Integrate it smoothly with the existing content, which is: \n\n${currentContent}\n\n Focus on compelling language, educational benefits, and interactive elements for children.`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate Section Content');
            });

            document.getElementById('editorRephraseTextBtn')?.addEventListener('click', async (event) => {
                const textToRephrase = document.getElementById('editorRephraseTextInput').value.trim();
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');    
                if (!textToRephrase) {
                    window.showCustomModal('Input Required', 'Please enter text into the "Rephrase/Improve Text" field.');
                    return;
                }
                const prompt = `Rephrase and improve the following text for clarity, conciseness, and impact, suitable for smart toy interaction or a parental dashboard. Provide 3 different versions as a markdown list. \n\n"${textToRephrase}"`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Rephrase/Improve');
            });

            // Function to update the integrated editor's iframe preview
            window.updateEditorPreview = function() {
                const code = document.getElementById('editorHtmlCssCode').value;
                const previewFrame = document.getElementById('editorLivePreviewFrame');
                if (previewFrame) {
                    const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                    doc.open();
                    doc.write(`
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Preview</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 0;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                    min-height: 100vh;
                                    background-color: #f8f8f8;
                                }
                                /* Styling for the generated content within the iframe preview */
                                .generated-content-wrapper {
                                    width: 100%;
                                    max-width: 600px; /* Constrain width for better readability */
                                    padding: 20px;
                                    box-sizing: border-box;
                                }
                                .generated-content-wrapper h1, .generated-content-wrapper h2 {
                                    color: #0071e3; /* Primary Blue */
                                    margin-bottom: 0.5rem;
                                }
                                .generated-content-wrapper h1 span {
                                    color: #facc15; /* Accent Yellow */
                                }
                                .generated-content-wrapper p {
                                    color: #424245;
                                    line-height: 1.6;
                                }
                                .generated-content-wrapper button {
                                    background-color: #facc15; /* Accent Yellow Button */
                                    color: black;
                                    padding: 10px 20px;
                                    border-radius: 8px;
                                    margin-top: 15px;
                                    border: none;
                                    cursor: pointer;
                                }
                                img {
                                    width: 100%;
                                    max-width: 500px;
                                    margin-top: 15px;
                                    border-radius: 8px;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="generated-content-wrapper">
                                ${code}
                            </div>
                        </body>
                        </html>
                    `);
                    doc.close();
                }
            };

            // Theme toggle logic
            const themeToggleBtn = document.getElementById('themeToggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    document.body.classList.toggle('light-mode');
                    const isLightMode = document.body.classList.contains('light-mode');
                    themeToggleBtn.innerHTML = isLightMode ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
                    
                    // Re-render charts to update colors based on new theme
                    renderViewContent(window.location.hash.substring(1) || 'dashboard');
                });
                // Set initial icon based on default theme
                const isLightMode = document.body.classList.contains('light-mode');
                themeToggleBtn.innerHTML = isLightMode ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            }
        });
    </script>
</body>
</html>
